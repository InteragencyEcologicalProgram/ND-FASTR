---
title: "NDFS Synthesis Manuscript: Chlorophyll analysis"
subtitle: "Models using daily average flow as continuous predictor"
author: "Dave Bosworth"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document: 
    code_folding: show
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    )
    })
    rmarkdown::render(
      input,
      envir = globalenv()
      output_dir = here::here("docs"),
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.kable.NA = "")
```

# Purpose

Explore and analyze the continuous chlorophyll data to be included in the NDFS synthesis manuscript. We will attempt to fit various models to the data set using daily average flow as a continuous predictor which replaces the categorical predictor - flow action period - in the original analysis. These models will only include representative stations for 4 habitat types - upstream (RD22), lower Yolo Bypass (STTD), Cache Slough complex (LIB), and downstream (RVB).

# Global code and functions

```{r load packages and functions, message = FALSE, warning = FALSE}
# Load packages
library(tidyverse)
library(scales)
library(knitr)
library(mgcv)
library(car)
library(gratia)
library(here)
library(conflicted)

# Source functions
source(here("manuscript_synthesis/src/global_functions.R"))

# Declare package conflict preferences 
conflicts_prefer(dplyr::filter(), dplyr::lag())
```

Display current versions of R and packages used for this analysis:

```{r print session info}
devtools::session_info()
```

# Import Data

```{r import data}
# Define file path for processed data
fp_data <- here("manuscript_synthesis/data/processed")

# Import weekly average chlorophyll data
df_chla <- readRDS(file.path(fp_data, "chla_wt_week_avg_2013-2019.rds")) %>% select(-WaterTemp)

# Import weekly average flow data
df_flow <- readRDS(file.path(fp_data, "flow_week_avg_2013-2019.rds"))
```

# Prepare Data

```{r prepare chla data, message = FALSE}
# Create a vector for the factor order of StationCode
sta_order <- c("RD22", "STTD", "LIB", "RVB")

# We will use LIS flow data as a proxy for STTD
df_flow_c <- df_flow %>% mutate(StationCode = if_else(StationCode == "LIS", "STTD", StationCode))

# Prepare chlorophyll and flow data for exploration and analysis
df_chla_c1 <- df_chla %>% 
  # Filter to only include representative stations for 4 habitat types - RD22, STTD, LIB, RVB
  filter(StationCode %in% sta_order) %>% 
  # Join flow data to chlorophyll data
  left_join(df_flow_c, by = join_by(StationCode, Year, Week)) %>% 
  # Remove all NA flow values
  drop_na(Flow) %>% 
  mutate(
    # Scale and log transform chlorophyll values
    Chla_log = log(Chla * 1000),
    # Add Year and DOY variables
    #Year = year(Date),
    #DOY = yday(Date),
    # Apply factor order to StationCode
    StationCode = factor(StationCode, levels = sta_order),
    # Add a column for Year as a factor for the model
    Year_fct = factor(Year)
  ) %>% 
  arrange(StationCode, Year, Week)
```

# Explore sample counts by Station

```{r chla sample counts station}
df_chla_c1 %>% 
  summarize(
    min_date = min(Week),
    max_date = max(Week),
    num_samples = n(),
    .by = c(StationCode, Year)
  ) %>% 
  arrange(StationCode, Year) %>% 
  kable()
```

Looking at the sample counts and date ranges, we'll only include years 2015-2019 for the analysis.

```{r chla remove under sampled}
df_chla_c2 <- df_chla_c1 %>% 
  filter(Year %in% 2015:2019) %>% 
  mutate(Year_fct = fct_drop(Year_fct))

# Create another dataframe that has up to 3 lag variables for chlorophyll to be
  # used in the linear models
df_chla_c2_lag <- df_chla_c2 %>% 
  # Fill in missing days for each StationCode-Year combination
  group_by(StationCode, Year) %>% 
  #complete(Date = seq.Date(min(Week), max(Week), by = "1 week")) %>% 
  # Create lag variables of scaled log transformed chlorophyll values
  mutate(
    lag1 = lag(Chla_log),
    lag2 = lag(Chla_log, 2),
    lag3 = lag(Chla_log, 3)
  ) %>% 
  ungroup()
```

# Plots

Let's explore the data with some plots. First, lets plot the data in scatterplots of chlorophyll and flow facetted by Station and grouping all years together.

```{r chla scatterplot all yrs, message = FALSE, fig.height = 6, fig.width = 6}
df_chla_c2 %>% 
  ggplot(aes(x = Flow, y = Chla)) +
  geom_point() +
  geom_smooth(formula = "y ~ x") +
  facet_wrap(vars(StationCode), scales = "free") +
  theme_bw()
```

At first glance, I'm not sure how well flow is going to be able to predict chlorophyll concentrations. At the furthest upstream station - RD22 - chlorophyll appears to be highest at the lowest flows, but the variation is at its maximum at the lowest flows. There may be some dilution effect going on here at the higher flows. At STTD, there does seem to be a modest increase in chlorophyll concentrations at the mid-range flows. This pattern is even more obvious at LIB. There appears to be no effect of flow on chlorophyll at RVB, but the range of chlorophyll concentrations is narrow at this station (between 0 and 5).

Let's break these scatterplots apart by year to see how these patterns vary annually.

```{r chla scatterplot facet yrs, message = FALSE, fig.height = 8, fig.width = 8}
df_chla_c2 %>% 
  ggplot(aes(x = Flow, y = Chla)) +
  geom_point() +
  geom_smooth(formula = "y ~ x") +
  facet_wrap(
    vars(StationCode, Year), 
    ncol = 5, 
    scales = "free", 
    labeller = labeller(.multi_line = FALSE)
  ) +
  theme_bw()
```

The patterns appear to vary annually at each station, which may justify using a 3-way interaction.

# GAM Model with 3-way interactions

First, we will attempt to fit a generalized additive model (GAM) to the data set to help account for seasonality in the data. We'll try running a GAM using a three-way interaction between Year, Daily Average Flow, and Station, and a smooth term for day of year to account for seasonality. Initially, we'll run the GAM without accounting for serial autocorrelation.

## Initial Model

```{r gam3 no autocorr, warning = FALSE}
m_gam3 <- gam(
  Chla_log ~ Year_fct * Flow * StationCode + s(Week), 
  data = df_chla_c2,
  method = "REML"
)
```

Lets look at the model summary and diagnostics:

```{r gam3 no autocorr diag, warning = FALSE}
summary(m_gam3)
appraise(m_gam3)
shapiro.test(residuals(m_gam3))
k.check(m_gam3)
draw(m_gam3, select = 1, residuals = TRUE, rug = FALSE)
plot(m_gam3, pages = 1, all.terms = TRUE)
acf(residuals(m_gam3))
Box.test(residuals(m_gam3), lag = 20, type = 'Ljung-Box')
```


## Model with first, second, and third order lag terms

Now, we'll try to deal with the residual autocorrelation. 

```{r gam3 with lag terms}

# Fit original model with k = 9 and three successive lagged models
#lag1
m_gam3_lag1 <- gam(
  Chla_log ~ lag1 + Year_fct * Flow * StationCode + s(Week), 
  data = df_chla_c2_lag,
  method = "REML"
)

summary(m_gam3_lag1)
appraise(m_gam3_lag1)
shapiro.test(residuals(m_gam3_lag1))
k.check(m_gam3_lag1)
draw(m_gam3_lag1, select = 1, residuals = TRUE, rug = FALSE)
plot(m_gam3_lag1, pages = 1, all.terms = TRUE)
acf(residuals(m_gam3_lag1))
Box.test(residuals(m_gam3_lag1), lag = 20, type = 'Ljung-Box')

#lag2
m_gam3_lag2 <- gam(
  Chla_log ~ lag1 + lag2 + Year_fct * Flow * StationCode + s(Week), 
  data = df_chla_c2_lag,
  method = "REML"
)

summary(m_gam3_lag2)
appraise(m_gam3_lag2)
shapiro.test(residuals(m_gam3_lag2))
k.check(m_gam3_lag2)
draw(m_gam3_lag2, select = 1, residuals = TRUE, rug = FALSE)
plot(m_gam3_lag2, pages = 1, all.terms = TRUE)
acf(residuals(m_gam3_lag2))
Box.test(residuals(m_gam3_lag2), lag = 20, type = 'Ljung-Box')

#compare fit of lag1 and lag2 models
AIC(m_gam3_lag1, m_gam3_lag2)

```

It looks like lag2 model has the best fit according to the AIC values. 

Let's take a closer look at how the back-transformed fitted values from the model match the observed values.

```{r gam3 ar1 obs vs fit, warning = FALSE}
df_m_gam3_lag2_fit <- df_chla_c2_lag %>% 
  fitted_values(m_gam3_lag2, data = .) %>% 
  mutate(fitted_bt = exp(fitted) / 1000)

plt_m_gam3_lag2_fit <- df_m_gam3_lag2_fit %>% 
  ggplot(aes(x = fitted_bt, y = Chla)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  theme_bw() +
  labs(
    x = "Back-transformed Fitted Values",
    y = "Observed Values"
  )

plt_m_gam3_lag2_fit
```

Let's look at each Station-Year combination separately.

```{r gam3 ar1 obs vs fit facet sta yr, fig.height = 8, fig.width = 8}
plt_m_gam3_lag2_fit +
  facet_wrap(
    vars(StationCode, Year_fct),
    ncol = 5,
    scales = "free",
    labeller = labeller(.multi_line = FALSE)
  )
```
