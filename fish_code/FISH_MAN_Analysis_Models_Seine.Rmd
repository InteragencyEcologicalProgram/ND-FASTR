---
title: "FISH_MAN_Analysis_Models_Seine"
author: "Catarina Pien"
date: "12/15/2020"
output: html_document
editor_options: 
  chunk_output_type: inline
---

Code for FASTR fish models for seine data
Fish ~ Region + Action Phase + Year

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages

```{r load, echo = FALSE, results = FALSE, warning = FALSE, message = FALSE}

rm(list=ls(all=TRUE))

library(tidyverse)
library(lubridate) # Datetime
library(pscl) # Run zips and zinbs
library(visreg) # Visualize models
library(viridis) # Color palette
library(emmeans) # post hoc
library(MASS) # negbin model
library(countreg) # zeroinfl and hurdle functions, qqrplot
library(gridExtra)
library(grid)
library(Polychrome)
library(plotly)
library(glmmTMB) # zeroinfl GLMM
library(lme4) # negbin GLMM

```

## Import data

* Fish_ndfa: integrated fish dataset
* Merge flow data into rest of data
* Define variable structures
* Order action phases

```{r import and filter dates, warning = FALSE, message = FALSE, results = FALSE}
setwd("C:/Users/cpien/OneDrive - California Department of Water Resources/Work/FASTR/FASTR/ND-FASTR")
Fish_ndfa_0 <- read.csv("fish data/FISH_MAN_allIEPsurveys_20201030.csv")
Fish_ndfa <- dplyr::select(Fish_ndfa_0, -c(Turbidity, DO, Latitude, Longitude))
FlowDesignation <- read.csv("fish data/FlowDatesDesignations_45days.csv")
Regions <- read.csv("fish data/Stations_Fish_NDFA_2021-01-13.csv")
Regions_min <- Regions %>% select(-c(Intersect, geometry, RegionMult)) %>%
  rename(Survey = Survey.x)
# Look at data
head(Fish_ndfa)
str(Fish_ndfa)

```

Modify the EDSM Stations - did not end up including this 

```{r}
library(nngeo)
library(sp)

setwd("C:/Users/cpien/OneDrive - California Department of Water Resources/Work/FASTR/FASTR/ND-FASTR")
#Regions2 <- Regions %>% 
#  mutate(StationType = ifelse(Survey.x == "EDSM", "Random", "Fixed"))
#
#EDSM <- filter(Regions2, Survey.x == "EDSM")
#StationRest <- filter(Regions, Survey.x != "EDSM")
#
## Change to shapefile - not sure if this is necessary but couldn't figure out otherwise how to get it to work
# coordinates(EDSM) = ~Longitude+Latitude
# proj4string(EDSM) = CRS("+proj=longlat +datum=WGS84")
# raster::shapefile(EDSM, "fish_code/R_write/EDSMShapefile.shp")
# 
# coordinates(StationRest) = ~Longitude+Latitude
# proj4string(StationRest) = CRS("+proj=longlat +datum=WGS84")
# raster::shapefile(StationRest, "fish_code/R_write/StationRestShapefile.shp")

EDSM_s <- st_read("fish_code/R_write/EDSMShapefile.shp")
StationRest_s <- st_read("fish_code/R_write/StationRestShapefile.shp")

# Run nearest neighbor
NN <- st_nn(EDSM_s, StationRest_s, progress = FALSE)

# Convert list into a data frame
df <- do.call(rbind.data.frame, NN)
colnames(df) <-  "Row"

# Extract the rest of the dataset based on the row number
result <- StationRest_s[df$Row,]

# Merge dataframes
EDSM_nn <- cbind(EDSM_s, result) %>%
  select(c(2, 9)) %>%
  rename(Neighbor = StatnCd.1,
         StationCode = StatnCd)
Regions3 <- left_join(Regions, EDSM_nn, by = "StationCode") %>%
  mutate(StationCodeF = ifelse(is.na(Neighbor), StationCode, Neighbor))
Regions_min <- Regions3 %>%
  rename(Survey = Survey.x) %>%
  dplyr::select(-c(Intersect, geometry.x, geometry.y, RegionMult, Neighbor))

summary(Regions_min)
```

Modifications to data frames and joins
```{r}
# Add variables
Fish_ndfa$Date <- ymd(Fish_ndfa$Date)
Fish_ndfa$Month <- month(Fish_ndfa$Date)
Fish_ndfa$Day <- day(Fish_ndfa$Date)
FlowDesignation$PreFlowStart <- mdy(FlowDesignation$PreFlowStart)
FlowDesignation$PreFlowEnd <- mdy(FlowDesignation$PreFlowEnd)
FlowDesignation$PostFlowStart <- mdy(FlowDesignation$PostFlowStart)
FlowDesignation$PostFlowEnd <- mdy(FlowDesignation$PostFlowEnd)

# Merge data from FlowDesignation Table (Water Year Type, Flow days and type)
# Filter only Pre-During-Post Flow Action Data. 
# We have a during action, and then Pre = 30 days before/Post = 30 days after
Fish_all0 <- inner_join(Fish_ndfa,FlowDesignation, by = "Year")
Fish_all1 <- left_join(Fish_all0, Regions_min, by = c("StationCode", "Survey"))

summary(Fish_all1)
# anti_join(Fish_all1, Fish_all0, by = colnames(Fish_all0))

Fish_all <- Fish_all1 %>%
   mutate(ActionPhase = ifelse(Date > PreFlowStart & Date<PreFlowEnd, "Pre", NA)) %>%
   mutate(ActionPhase = replace(ActionPhase, Date > PreFlowEnd & Date < PostFlowStart, "During")) %>%
   mutate(ActionPhase = replace(ActionPhase, Date > PostFlowStart & Date < PostFlowEnd, "Post")) %>%
  filter(!is.na(ActionPhase)) %>%
   dplyr::select(-c(PreFlowStart:PostFlowEnd)) %>%
   arrange(Date, Survey, StationCode, CommonName)

# Define variable structures
Fish_all$Date <- ymd(Fish_all$Date)
Fish_all$fYear <- as.factor(Fish_all$Year)
Fish_all$WYType <- as.factor(Fish_all$WYType)
Fish_all$FlowPulseType <- as.factor(Fish_all$FlowPulseType)
Fish_all$ActionPhase <- as.factor(Fish_all$ActionPhase)
Fish_all$X1 <- NULL
Fish_all$Survey <- as.factor(Fish_all$Survey)
Fish_all$StationCode <- as.factor(Fish_all$StationCode)
Fish_all$MethodCode <- as.factor(Fish_all$MethodCode)
Fish_all$Region <- factor(Fish_all$Region, levels = c("Upstream", "Downstream", "MiddleSacRiver"))
Fish_all$ActionPhase <-  factor(Fish_all$ActionPhase, levels(Fish_all$ActionPhase)[c(2,3,1)])
str(Fish_all)
levels(Fish_all$ActionPhase)
```

## Data Prep

* Filter to just Seine data
* Fill in zeros for unlisted species
* Calculate CPUE 
* Organize data the way you want it

```{r seine, warning = FALSE, message = FALSE}
# Filter Dataset
Seine <-  Fish_all %>% filter(MethodCode == "SEIN" | MethodCode == "BSEIN") %>%
  filter(Year>2012)%>%
arrange(Survey, Date, StationCode)

### Complete Cases
# For each Date, Survey, StationCode combination, make sure each fish species is represented with 
# either positive count or zero. 
Seine_completecase <- Seine %>%
  group_by(Date, Survey, StationCode, CommonName) %>%
  summarize(sum.count = sum(totalCount)) %>%
  ungroup() %>%
  complete(CommonName, nesting(Date, Survey, StationCode), fill = list(sum.count = 0)) %>%
  arrange(Date,Survey, StationCode,CommonName)

### Merge back together with rest of data

# Get distinct samples for looking at Water Quality 
Seine_samples <- Seine %>% dplyr::select(-c(CommonName, totalCount)) %>% distinct()

# Merge 
Seine_complete <- left_join(Seine_completecase, Seine_samples, by = c("Date", "Survey", "StationCode"))
# There is a Yolo sample with two volumes... this is why there are more rows of Seine_complete

### Calculate CPUE
# Remove samples with no volume 
Seine_CPUE <- Seine_complete %>%
  filter(!is.na(VolumeSampled))%>%
  mutate(CPUE = round(sum.count/VolumeSampled,2))

### Rearrange columns 
Seine_f <- Seine_CPUE[, c("Date", "Year", "fYear" , "Survey", "StationCode",                           "Latitude", "Longitude","MethodCode",
                         "WYType", "FlowPulseType", "NetFlowDays","ActionPhase", "Region", "Secchi",  "Conductivity", "WaterTemp", "VolumeSampled",  "CommonName", "sum.count", "CPUE")]

### Mean CPUE 
## Calculate means for each species by year-location-actionphase
CPUE_means_seine_phase <- Seine_f %>%
  group_by(Year, Survey, StationCode, ActionPhase, CommonName) %>% 
  summarize(mean.CPUE = mean(CPUE)) 
```


```{r}
### Mean CPUE 
## Calculate means for each species by year-location-actionphase
CPUE_means_Seine_phase <- Seine_f %>%
  group_by(Year, Survey, StationCode, ActionPhase, CommonName) %>% 
  summarize(mean.CPUE = mean(CPUE)) 
```


## Filter for species sets

```{r Seine filters, warning = FALSE, message = FALSE}
# Lists
list_native <- c("Sacramento Pikeminnow", "Splittail", "Hitch", "Hardhead", "Sacramento Sucker", "Sacramento Blackfish")
list_smeltish <- c("Wakasagi", "Inland Silverside", "Delta Smelt")

Seine_natives0 <- Seine_f %>%filter(CommonName %in% list_native)
Seine_smeltish0 <- Seine_f %>% filter(CommonName %in% list_smeltish) %>%
  arrange(CommonName, CPUE)
```

## Run Models {.tabset}

### Smeltish

#### Sum smeltish into one CPUE/seine
```{r}
Seine_smeltish <- Seine_smeltish0 %>%
  group_by(Date, Survey, fYear, StationCode, ActionPhase, Region, VolumeSampled) %>%
  summarize(sumCPUE = sum(CPUE),
            sumCount = sum(sum.count))

Seine_smeltish$ActionPhase <-  factor(Seine_smeltish$ActionPhase, levels(Seine_smeltish$ActionPhase)[c(2,3,1)])


```

#### Look at data

**Pretty much all Silversides (6 Wakasagi caught total)**

* Lots of zeros
* More fish from DJFMP
* No clear pattern Action Phase, Region

```{r}
# Proportion ISS vs Wakasagi
ggplot(Seine_smeltish0, aes(x = fYear, y = CPUE, fill = CommonName)) + geom_col()+ theme_bw()

# Histogram
ggplot(Seine_smeltish, aes(sumCPUE)) + geom_histogram(binwidth = 1) + theme_bw()

# Survey
ggplot(Seine_smeltish, aes(x = Date, y = sumCPUE)) + geom_point() + facet_wrap(Survey~.) + theme_bw()

# Action Phase
ggplot(Seine_smeltish, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Region
ggplot(Seine_smeltish, aes(x = Region, y = sumCPUE)) + geom_jitter(aes(color = ActionPhase), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Year 
ggplot(Seine_smeltish, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + facet_wrap(~fYear) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

Seine_summary_yr1 <- Seine_smeltish %>% 
  group_by(fYear, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

ggplot(Seine_summary_yr1, aes(x = fYear, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = ActionPhase)) + 
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15),
        legend.position = "bottom")

Seine_summary_yr2 <- Seine_smeltish %>% 
  group_by(fYear, Region) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

ggplot(Seine_summary_yr2, aes(x = fYear, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = Region)) + 
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15),
        legend.position = "bottom")

Seine_summary_yr3 <- Seine_smeltish %>% 
  group_by(fYear, Region, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

Seine_summary_yr4 <- Seine_smeltish %>% 
  group_by(fYear, Region, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = length(unique(StationCode)),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

```
2015 + 2018 similar
2014 + 2017 similar


# Barplot for final figure 
# Summarize - Mean + Standard Error
```{r}
Seine_summary <- Seine_smeltish %>% 
  group_by(Region, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

plot1 <- ggplot(Seine_summary, aes(x = ActionPhase, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = Region)) + 
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + theme_bw() + 
    annotate("text", x = "Post", y = 12, label = "A", size = 8) + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15),
        legend.position = "bottom")
plot1
```

IGNORE
Initial model - QQ plot doesn't look good
```{r}

(M.smeltish1 <- glm(sumCPUE~FlowPulseType + Region + fYear + ActionPhase, data  = Seine_smeltish))
summary(M.smeltish1)
par(mfrow = c(2,2))
plot(M.smeltish1)
```

IGNORE
Using transformations - doesn't work well either
```{r}
(M.smeltish2 <- glm(log(sumCPUE+1)~FlowPulseType + Region + fYear + ActionPhase, data  = Seine_smeltish))
summary(M.smeltish1)
par(mfrow = c(2,2))
plot(M.smeltish1)

logCPUE <-  log(Seine_smeltish$sumCPUE + 1)
hist(logCPUE)
```

IGNORE
#### Zero-inflated model
```{r} 
# For CPUE, use offset to account for sampling effort
Seine_smeltish$Samp <- log(Seine_smeltish$VolumeSampled)

# Formula
f1 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))

# Negbin
zinb1 <- zeroinfl(f1, na.action = "na.fail", dist="negbin", link = "logit", data = Seine_smeltish) ; summary(zinb1)

# Poisson
zip1 <- zeroinfl(f1, dist = "poisson", link = "logit", data = Seine_smeltish); summary(zip1)

# Hurdle 
hrd1 <- hurdle(f1, dist="negbin", data = Seine_smeltish); summary(hrd1)

```

IGNORE
Compare zero-inflated poisson, zero-inflated negbin, hurdle
```{r}
library(lmtest)
lrtest(zip1, zinb1)

# check all 3
BIC(zip1, zinb1, hrd1)
```

IGNORE
ZINB is the best. 
Compare zinb with nb, make sure zero inflation is the way to go
```{r}
# No zero inflation
nb1 <- glm.nb(f1,  data = Seine_smeltish) ; summary(nb1) 
vuong(nb1, zinb1)
```
It is. 

IGNORE
Try glmmAdaptive (hurdle negative binomial)
```{r}
library(GLMMadaptive)
hm1 <- mixed_model(sumCount ~ Region + ActionPhase + offset(Samp), random = ~1|StationCode, data = Seine_no2019, 
                  family = hurdle.negative.binomial(), zi_fixed = ~.)
```


IGNORE
Run glmmTMB (negative binomial mixed modeling) to include station as random effect

```{r}
Seine_no2019 <- Seine_smeltish %>% filter(fYear != "2019")

# Formula
f2 <- formula(sumCount ~ Region +  ActionPhase + offset(Samp) + (1|StationCode) + (1|fYear))

f3 <- formula(sumCount ~ Region + fYear*ActionPhase  + offset(Samp) + (1|StationCode))

M.glmmnb1 <- glmmTMB(f2, family = nbinom1, ziformula = ~., data = Seine_no2019); summary(M.glmmnb1)
M.glmmnb2 <- glmmTMB(f3, family = nbinom2, ziformula = ~., data = Seine_smeltish); summary(M.glmmnb2)
```
IGNORE
Compare models
```{r}
AIC(M.glmmnb1, M.glmmnb2)
```

**Is this AIC difference worth the interactions?**

IGNORE
#### Diagnostic Plots
https://cran.r-project.org/web/packages/glmmTMB/vignettes/model_evaluation.pdf
```{r}
library(DHARMa)
par(mfrow = c(1,2))

Msmelt.simres <- simulateResiduals(M.glmmnb1)
plot(Msmelt.simres)

```

IGNORE
Distribution of residuals by variable
```{r}
EP1 <- resid(M.glmmnb1, type = "pearson")

# Diagnostic Plots
par(mfrow = c(2,2))

plot(x=Seine_smeltish$ActionPhase,y = EP1, main = "Action Phase")
plot(x=Seine_smeltish$Region, y = EP1, main = "Region")
plot(x=Seine_smeltish$fYear, y = EP1, main = "Year")
```

IGNORE
Look at overall relationships
```{r}
par(mfrow = c(2,2))
visreg(M.glmmnb1)
```


UPDATED MODEL CODE
Remove station effects by averaging into Region. Use this data for model.
```{r}
Seine_smeltish2 <- Seine_smeltish %>%
  group_by(fYear, Region, ActionPhase) %>%
  summarize(sumCount2 = sum(sumCount),
            sumVol = sum(VolumeSampled),
            sumCPUE2 = sum(sumCPUE),
            meanCPUE = mean(sumCPUE))

Seine_smeltish2$ActionPhase <-  factor(Seine_smeltish2$ActionPhase, levels(Seine_smeltish2$ActionPhase)[c(2,3,1)])

```

UPDATED MODEL CODE
Run models
```{r}
(M.smeltish1 <- glm(meanCPUE~Region + fYear + ActionPhase, data  = Seine_smeltish2))
summary(M.smeltish1)

(M.smeltish2 <- glm(meanCPUE~Region + fYear * ActionPhase, data  = Seine_smeltish2))
summary(M.smeltish2)

AIC(M.smeltish1, M.smeltish2)
```

UPDATED MODEL CODE
Diagnostic Plots
```{r}
par(mfrow = c(2,2))
plot(M.smeltish1)
```

**Should we remove Point 50 as an outlier??**
Attributed to 2-3 very high catches from DJFMP. Because more than 1, likely real, but definitely is an outlier in the data. 

UPDATED MODEL CODE
Post-hoc

```{r}
m_means1a <- emmeans(M.smeltish1, pairwise~fYear, adjust="sidak")
m_means1a

m_means1b <- emmeans(M.smeltish1, pairwise~Region, adjust="sidak")
m_means1b

m_means1c <- emmeans(M.smeltish1, pairwise~ActionPhase, adjust="sidak")
m_means1c
```

UPDATED MODEL CODE
**Conclusions**

* Keep in mind this is mostly Inland Silversides 
* More smeltish downstream, compared with Middle Sac + upstream
* More smeltish pre, then during, then post, though not significant in the multcomp tests
* Model shows 2018 to be higher, but multcomp test does not indicate any significant differences. 








### Native fishes

#### Sum natives into one CPUE/seine
```{r}
Seine_natives <- Seine_natives0 %>%
  group_by(Date, Survey, fYear, StationCode, FlowPulseType, ActionPhase, Region, VolumeSampled) %>%
  summarize(sumCPUE = sum(CPUE),
            sumCount = sum(sum.count))
```

#### Look at data

* Good proportions - mostly Sucker, Pikeminnow, some years Splittail
* Lots of zeros, usually low catch when there is catch
* More fish from DJFMP
* More pre, Middle-Sac River

```{r}
# Proportion Species
ggplot(Seine_natives0, aes(x = fYear, y = CPUE, fill = CommonName)) + geom_col()+ theme_bw() + scale_fill_viridis(discrete = TRUE, option = "plasma")

# Histogram
ggplot(Seine_natives, aes(sumCPUE)) + geom_histogram(binwidth = .1) + theme_bw()

# Survey
ggplot(Seine_natives, aes(x = Date, y = sumCPUE)) + geom_point() + facet_wrap(Survey~.) + theme_bw()

# Action Phase
ggplot(Seine_natives, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Region
ggplot(Seine_natives, aes(x = Region, y = sumCPUE)) + geom_jitter(aes(color = ActionPhase), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Year 
ggplot(Seine_natives, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + facet_wrap(~fYear) + scale_color_viridis(discrete = TRUE, option = "magma") + theme_bw()

Seine_summary_yr3 <- Seine_natives %>% 
  group_by(fYear, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

ggplot(Seine_summary_yr3, aes(x = fYear, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = ActionPhase)) + 
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15),
        legend.position = "bottom")

Seine_summary_yr4 <- Seine_natives %>% 
  group_by(fYear, Region) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

ggplot(Seine_summary_yr4, aes(x = fYear, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = Region)) + 
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15),
        legend.position = "bottom")
```
2016 and 2019 very similar trends by Region and higher CPUE overall.

# Barplot
# Summarize - Mean + Standard Error
```{r}
Seine_summary2 <- Seine_natives %>% 
  group_by(Region, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

plot2 <- ggplot(Seine_summary2, aes(x = ActionPhase, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = Region)) + 
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + theme_bw() + 
    annotate("text", x = "Post", y = .2, label = "B", size = 8)  + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15),
        legend.position = "none")

plot2
```

IGNORE
#### Zero-inflated model
```{r}
# For CPUE, use offset to account for sampling effort
Seine_natives$Samp <- log(Seine_natives$VolumeSampled)

# Formula
f1 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))

# Negbin
zinb2 <- zeroinfl(f1, na.action = "na.fail", dist="negbin", link = "logit", data = Seine_natives) ; summary(zinb2)

# Poisson
zip2 <- zeroinfl(f1, dist = "poisson", link = "logit", data = Seine_natives); summary(zip2)

# Hurdle
hrd2 <- hurdle(f1, dist="negbin", data = Seine_natives); summary(hrd2)
```
IGNORE
Compare zero-inflated poisson with zero-inflated negbin
```{r}
library(lmtest)
lrtest(zip2, zinb2)
# Significantly different 

BIC(zip2, zinb2, hrd2)
```
IGNORE
ZINB is the best. 
Compare zinb with nb, make sure zero inflation is the way to go
```{r}
# No zero inflation
nb2 <- glm.nb(f1,  data = Seine_natives) ; summary(nb2) 
vuong(nb2, zinb2)
```
This is unclear. 

IGNORE
Run glmmTMB (negative binomial mixed modeling) to include station as random effect
```{r}
# Formula
f2 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp) + (1|StationCode))
f3 <- formula(sumCount ~ Region + fYear*ActionPhase  + offset(Samp) + (1|StationCode))

M.glmmnb3 <- glmmTMB(f2, family = nbinom1, ziformula = ~., data = Seine_natives); summary(M.glmer1)
M.glmmnb4 <- glmerTMB(f3, family = nbinom1, ziformula = ~., data = Seine_natives); summary(M.glmer2)

AIC(M.glmmnb3, M.glmmnb4)
```

IGNORE
#### Diagnostic Plots

Rootograms - should like like a typical overdispersed distribution
This compares observed and fitted frequencies
qqrplot
```{r}
par(mfrow = c(1,2))
rootogram(zinb2, main = "ZINB", ylim = c(-5, 15), max = 50)
qqrplot(zinb2)
```
IGNORE
Distribution of residuals by variable
```{r}

# Calculate residuals
EP2 <- resid(zinb2, type = "pearson")

# Diagnostic Plots
par(mfrow = c(2,2))
plot(x=Seine_natives$ActionPhase,y = EP2, main = "Action Phase")
plot(x=Seine_natives$Region, y = EP2, main = "Region")
plot(x=Seine_natives$fYear, y = EP2, main = "Year")

levels(Seine_natives$fYear)
```
IGNORE
View Results
```{r}
par(mfrow = c(2,2))
visreg(zinb2)
```
IGNORE
Post-hoc
```{r}
m_means2 <- emmeans(zinb2, ~fYear)
multcomp::cld(m_means2, Letters = letters)
```







UPDATED MODEL CODE
Remove station effects by averaging into Region. Use this data for model.
```{r}
Seine_natives2 <- Seine_natives %>%
  group_by(fYear, Region, ActionPhase) %>%
  summarize(sumCount2 = sum(sumCount),
            sumVol = sum(VolumeSampled),
            sumCPUE2 = sum(sumCPUE),
            meanCPUE = mean(sumCPUE))

Seine_natives2$ActionPhase <-  factor(Seine_natives2$ActionPhase, levels(Seine_natives2$ActionPhase)[c(2,3,1)])

```
UPDATED MODEL CODE
Run models
```{r}
(M.natives1 <- glm(meanCPUE~Region + fYear + ActionPhase, data  = Seine_natives2))
summary(M.natives1)

(M.natives2 <- glm(meanCPUE~Region + fYear * ActionPhase, data  = Seine_natives2))
summary(M.natives2)

AIC(M.natives1, M.natives2)
```
UPDATED MODEL CODE
Diagnostic Plots
```{r}
par(mfrow = c(2,2))
plot(M.natives1)
```

**Should we remove Points 34 and 61 as outliers??**

UPDATED MODEL CODE
Post-hoc

```{r}
m_means2a <- emmeans(M.natives1, pairwise~fYear, adjust="sidak")
m_means2a

m_means2b <- emmeans(M.natives1, pairwise~Region, adjust="sidak")
m_means2b

m_means2c <- emmeans(M.natives1, pairwise~ActionPhase, adjust="sidak")
m_means2c
```



UPDATED MODEL CODE
**Conclusions**

* More natives MiddleSac River compared with Downstream and Upstream
* More natives Pre compared with During and Post. 
* 2016, 2019 higher CPUE though not significantly so. Lowest CPUEs 2014, 2015. 







### Overall CPUE
* Not zero-inflated

#### Sum Overall CPUE
```{r}
Seine_filter <- filter(Seine_f, !CommonName %in% c("NoCatch", "Crangon spp.", "Siberian Prawn", "Mississippi Grass Shrimp", "Unknown"))

# Only species that are most common
SeineSpCPUE <- Seine_f %>% 
  group_by(CommonName) %>%
  filter(CPUE>0)%>%
  summarize(n = n(),
            prop = n/1426)
SeineSpCPUEA <- filter(SeineSpCPUE, prop>0.01)

spAb <- as.vector(SeineSpCPUEA$CommonName)
Seine_f_2 <- filter(Seine_f, CommonName %in% spAb)

# Combine all fish CPUEs per day
Seine_all <- Seine_f_2 %>%
  group_by(Survey,fYear, Date, Region, StationCode, ActionPhase, MethodCode, VolumeSampled) %>%
  summarize(sumCPUE = sum(CPUE),
            sumCount = sum(sum.count))

```

#### Look at data  

* Lots of silversides
* Definite overdispersion
* More catch DJFMP
* Doesn't look uch different between phases, but a few high catches in Pre
* More downstream

Species Composition Plot
```{r}
pal36 <- palette36.colors(26)
pal36 <- as.vector(t(pal36))

# Proportion Species
SeineSp <- ggplot(Seine_f_2, aes(x = fYear, y = CPUE, fill = CommonName)) + geom_col()+
  scale_fill_manual(values = pal36) +
  theme_bw()  + theme(legend.position = "bottom") +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        axis.title.x = element_blank(),
        legend.text = element_text(size = 11),
        legend.title = element_blank())
SeineSp
```


Rest of plots
```{r}
# Histogram
ggplot(Seine_all, aes(sumCPUE)) + geom_histogram(binwidth = .1) + theme_bw()

# Survey
ggplot(Seine_all, aes(x = Date, y = sumCPUE)) + geom_point() + facet_wrap(Survey~.) + theme_bw()

# Action Phase
ggplot(Seine_all, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Region
ggplot(Seine_all, aes(x = Region, y = sumCPUE)) + geom_jitter(aes(color = ActionPhase), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Year 
ggplot(Seine_all, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + facet_wrap(~fYear) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()
```

# Barplot
# Summarize - Mean + Standard Error
```{r}
Seine_summary3 <- Seine_all %>% 
  group_by(Region, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

# Order Action Phases
Fish_all$ActionPhase <- as.factor(Fish_all$ActionPhase)
Seine_all$ActionPhase <-  factor(Seine_all$ActionPhase, levels(Seine_all$ActionPhase)[c(1, 2, 3)])

plot3 <- ggplot(Seine_summary3, aes(x = ActionPhase, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = Region)) + 
  
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + theme_bw() + 
  annotate("text", x = "Post", y = 14, label = "C", size = 8)  + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15),
        legend.position = "none")

plot3

```

Merge plots - keep working

https://github.com/tidyverse/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs
```{r}

library(gridExtra)
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

legend <- get_legend(plot1)
plot1 <- plot1 + theme(legend.position = "none")
grid.arrange(plot1, plot2, plot3, legend)
#grid.arrange(arrangeGrob(plot1, plot4, plot2, top = "Seine"), arrangeGrob(plot5, plot3, plot6, top = "Tow"), legend, ncol = 2)
```

```{r}
grid_arrange_shared_legend <- function(..., ncol = length(list(...)), nrow = 1, position = c("bottom", "right")) {

  plots <- list(...)
  position <- match.arg(position)
  g <- ggplotGrob(plots[[1]] + theme(legend.position = position))$grobs
  legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
  lheight <- sum(legend$height)
  lwidth <- sum(legend$width)
  gl <- lapply(plots, function(x) x + theme(legend.position="none"))
  gl <- c(gl, ncol = ncol, nrow = nrow)

  combined <- switch(position,
                     "bottom" = arrangeGrob(do.call(arrangeGrob, gl),
                                            legend,
                                            ncol = 1,
                                            heights = unit.c(unit(1, "npc") - lheight, lheight)),
                     "right" = arrangeGrob(do.call(arrangeGrob, gl),
                                           legend,
                                           ncol = 2,
                                           widths = unit.c(unit(1, "npc") - lwidth, lwidth)))

  grid.newpage()
  grid.draw(combined)

  # return gtable invisibly
  invisible(combined)

}

grid_arrange_shared_legend(plot1, plot4, plot2, plot5, plot3, plot6, ncol = 2,nrow = 3)
grid_arrange_shared_legend(SeineSp, TowSp, ncol = 1, nrow = 2)

SeineSp
grid.arrange(SeineSp, TowSp)
```


#### Model - normal glm
```{r}
m1all <- glm(sumCPUE~Region + fYear + ActionPhase, data = Seine_all); summary(m1all)

par(mfrow = c(2,2))
plot(m1all)
```

#### Model with log transformation
```{r}
Seine_all$logCPUE = log(Seine_all$sumCPUE + 1)
m2all <- glm(logCPUE~Region + fYear + ActionPhase, data = Seine_all); summary(m2all)

par(mfrow = c(2,2))
plot(m2all)

hist(Seine_all$logCPUE)
```

#### Model with poisson distribution
```{r}
# For CPUE, use offset to account for sampling effort
Seine_all$Samp <- log(Seine_all$VolumeSampled)

# Formula
f1 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))
f2 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp) + (1|StationCode))
f3 <- formula(sumCount ~ Region + fYear*ActionPhase  + offset(Samp) + (1|StationCode))



f4 <- formula(sumCount ~ Region + fYear + ActionPhase + Region:ActionPhase+  offset(Samp))
f5 <- formula(sumCount ~ Region + fYear + ActionPhase + Region:fYear+  offset(Samp))
f6 <- formula(sumCount ~ Region + fYear + ActionPhase + ActionPhase:fYear+  offset(Samp))

# Check overdispersion (var>mean)
var(Seine_all$sumCPUE)
mean(Seine_all$sumCPUE)


# Poisson distribution or quasipoisson (overdispersed)
m3all <- glm(f1, data = Seine_all, family = poisson); summary(m3all)

# Model dispersion
deviance(m3all)/m3all$df.residual # very overdispersed


```

#### Model with negative binomial distribution
* https://stats.idre.ucla.edu/r/dae/negative-binomial-regression/


```{r}
m4all <- glm.nb(f1, data = Seine_all); summary(m4all)
# Confidence Intervals 
(est <- cbind(Estimate = coef(m4all), confint(m4all)))

# Incidence Rates (Count)
exp(est)
```

# Compare the two
```{r}
BIC(m3all, m4all)
```
Negative Binomial preferred.

Try interactions: m4all (no interactions) still best model
```{r}
m5all <- glm.nb(f4, data = Seine_all); summary(m5all)
m6all <- glm.nb(f5, data = Seine_all); summary(m6all)
m7all <- glm.nb(f6, data = Seine_all); summary(m7all)

BIC(m4all, m5all, m6all, m7all)
```

#### Diagnostic Plots

Rootogram and qqrplot
```{r}
par(mfrow = c(1,2))
rootogram(m4all)
qqrplot(m4all)
```

Plot residuals
```{r}
# Diagnostic Plots -------------------------------------
# Model Validation 
# Calculate residuals
EP3 <- resid(m4all, type = "pearson")

# Diagnostic Plots
par(mfrow = c(2,2))
plot(x=m4all$fitted.values, y = EP3, main = "Pearson residuals")
plot(x=Seine_all$ActionPhase,y = EP3, main = "Action Phase")
plot(x=Seine_all$Region, y = EP3, main = "Region")
plot(x=Seine_all$fYear, y = EP3, main = "Year")

```

View plot
```{r}
par(mfrow = c(2,2))
visreg(m4all)
```





UPDATED MODEL CODE
Mixed modeling
```{r}

# For CPUE, use offset to account for sampling effort
Seine_all$Samp <- log(Seine_all$VolumeSampled)

# Formula
f1 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))
f2 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp) + (1|StationCode))
f3 <- formula(sumCount ~ Region + fYear*ActionPhase  + offset(Samp) + (1|StationCode))

M.glmer1 <- glmer.nb(f2, data = Seine_all); summary(M.glmer1)
```
UPDATED MODEL CODE
Post-hoc

```{r}
m_means3a <- emmeans(M.glmer1, pairwise~fYear, adjust="sidak")
m_means3a

m_means3b <- emmeans(M.glmer1, pairwise~Region, adjust="sidak")
m_means3b

m_means3c <- emmeans(M.glmer1, pairwise~ActionPhase, adjust="sidak")
m_means3c
```
UPDATED MODEL CODE
**Conclusions**

* More fish Downstream > Upstream > Middle Sac (not significant)
* More fish Pre and During > Post 
* Years: highest 2015, 2017-2019, 2016, 2013, 2014
  * 2015>2016, 2018>2014, 2017>2014, 2015>2014. 2015>2013, 2017>2013, 2018>2013 





UPDATED MODEL CODE
Remove station effects by averaging into Region. Use this data for model.
```{r}
Seine_all2 <- Seine_all %>%
  group_by(fYear, Region, ActionPhase) %>%
  summarize(sumCount2 = sum(sumCount),
            sumVol = sum(VolumeSampled),
            sumCPUE2 = sum(sumCPUE),
            meanCPUE = mean(sumCPUE))

Seine_all2$ActionPhase <-  factor(Seine_all2$ActionPhase, levels(Seine_all2$ActionPhase)[c(2,3,1)])

```
UPDATED MODEL CODE
Run models
```{r}
(M.all1 <- glm(meanCPUE~Region + fYear + ActionPhase, data  = Seine_all2))
summary(M.all1)

(M.all2 <- glm(meanCPUE~Region * ActionPhase + fYear, data  = Seine_all2))
summary(M.all2)

AIC(M.all1, M.all2)
```
UPDATED MODEL CODE
Diagnostic Plots
```{r}
par(mfrow = c(2,2))
plot(M.all1)
```

**Should we remove Point 49 as outlier?**
UPDATED MODEL CODE
Post-hoc

```{r}
m_means4a <- emmeans(M.all1, pairwise~fYear, adjust="sidak")
m_means4a

m_means4b <- emmeans(M.all1, pairwise~Region, adjust="sidak")
m_means4b

m_means4c <- emmeans(M.all1, pairwise~ActionPhase, adjust="sidak")
m_means4c
```
UPDATED MODEL CODE
**Conclusions**

* More fish Downstream vs Upstream and Middle Sac
* More fish Pre > Post, not other significant differences 
* More fish 2018 but not significant in multcomp
