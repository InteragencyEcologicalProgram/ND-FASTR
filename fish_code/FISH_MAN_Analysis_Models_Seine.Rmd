---
title: "FISH_MAN_Analysis_Models_Seine"
author: "Catarina Pien"
date: "12/15/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

Code for FASTR fish models for seine data
Fish ~ Region + Action Phase + Year

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages

```{r load, echo = FALSE, results = FALSE, warning = FALSE, message = FALSE}

rm(list=ls(all=TRUE))

library(tidyverse)
library(lubridate) # Datetime
library(pscl) # Run zips and zinbs
library(visreg) # Visualize models
library(viridis) # Color palette
library(emmeans) # post hoc
library(MASS) # negbin model
library(countreg) # zeroinfl and hurdle functions, qqrplot
library(gridExtra)
library(grid)

```

## Import data

* Fish_ndfa: integrated fish dataset
* Merge flow data into rest of data
* Define variable structures
* Order action phases

```{r import and filter dates, warning = FALSE, message = FALSE, results = FALSE}
setwd("C:/Users/cpien/OneDrive - California Department of Water Resources/Work/FASTR/FASTR/ND-FASTR")
Fish_ndfa_0 <- read.csv("fish data/FISH_MAN_allIEPsurveys_20201030.csv")
Fish_ndfa <- dplyr::select(Fish_ndfa_0, -c(Turbidity, DO, Latitude, Longitude))
FlowDesignation <- read.csv("fish data/FlowDatesDesignations_45days.csv")
Regions <- read.csv("fish data/Stations_Fish_NDFA_2021-01-13.csv")
Regions_min <- Regions %>%
  rename(Survey = Survey.x) %>%
  dplyr::select(-c(Intersect, geometry, RegionMult))

# Look at data
head(Fish_ndfa)
str(Fish_ndfa)

# Add variables
Fish_ndfa$Date <- ymd(Fish_ndfa$Date)
Fish_ndfa$Month <- month(Fish_ndfa$Date)
Fish_ndfa$Day <- day(Fish_ndfa$Date)
FlowDesignation$PreFlowStart <- mdy(FlowDesignation$PreFlowStart)
FlowDesignation$PreFlowEnd <- mdy(FlowDesignation$PreFlowEnd)
FlowDesignation$PostFlowStart <- mdy(FlowDesignation$PostFlowStart)
FlowDesignation$PostFlowEnd <- mdy(FlowDesignation$PostFlowEnd)

# Merge data from FlowDesignation Table (Water Year Type, Flow days and type)
# Filter only Pre-During-Post Flow Action Data. 
# We have a during action, and then Pre = 30 days before/Post = 30 days after
Fish_all0 <- inner_join(Fish_ndfa,FlowDesignation, by = "Year")
Fish_all1 <- left_join(Fish_all0, Regions_min, by = c("StationCode", "Survey"))

# anti_join(Fish_all1, Fish_all0, by = colnames(Fish_all0))

Fish_all <- Fish_all1 %>%
   mutate(ActionPhase = ifelse(Date > PreFlowStart & Date<PreFlowEnd, "Pre", NA)) %>%
   mutate(ActionPhase = replace(ActionPhase, Date > PreFlowEnd & Date < PostFlowStart, "During")) %>% 
   mutate(ActionPhase = replace(ActionPhase, Date > PostFlowStart & Date < PostFlowEnd, "Post")) %>%
  filter(!is.na(ActionPhase)) %>%
   dplyr::select(-c(PreFlowStart:PostFlowEnd)) %>%
   arrange(Date, Survey, StationCode, CommonName)


# Order Action Phases
Fish_all$ActionPhase <- as.factor(Fish_all$ActionPhase)
Fish_all$ActionPhase <-  factor(Fish_all$ActionPhase, levels(Fish_all$ActionPhase)[c(3,1,2)])

# Define variable structures
str(Fish_all)

Fish_all$Date <- ymd(Fish_all$Date)
Fish_all$fMonth <- as.factor(Fish_all$Month)
Fish_all$fYear <- as.factor(Fish_all$Year)
Fish_all$WYType <- as.factor(Fish_all$WYType)
Fish_all$FlowPulseType <- as.factor(Fish_all$FlowPulseType)
Fish_all$ActionPhase <- as.factor(Fish_all$ActionPhase)
Fish_all$X1 <- NULL
Fish_all$Survey <- as.factor(Fish_all$Survey)
Fish_all$StationCode <- as.factor(Fish_all$StationCode)
Fish_all$MethodCode <- as.factor(Fish_all$MethodCode)
Fish_all$Region <- as.factor(Fish_all$Region)

str(Fish_all)

```


## Data Prep

* Filter to just Seine data
* Fill in zeros for unlisted species
* Calculate CPUE 
* Organize data the way you want it

```{r seine, warning = FALSE, message = FALSE}
# Filter Dataset
Seine <-  Fish_all %>% filter(MethodCode == "SEIN" | MethodCode == "BSEIN") %>%
  filter(Year>2012)%>%
arrange(Survey, Date, StationCode)

### Complete Cases
# For each Date, Survey, StationCode combination, make sure each fish species is represented with 
# either positive count or zero. 
Seine_completecase <- Seine %>%
  group_by(Date, Survey, StationCode, CommonName) %>%
  summarize(sum.count = sum(totalCount)) %>%
  ungroup() %>%
  complete(CommonName, nesting(Date, Survey, StationCode), fill = list(sum.count = 0)) %>%
  arrange(Date,Survey, StationCode,CommonName)

### Merge back together with rest of data

# Get distinct samples for looking at Water Quality 
Seine_samples <- Seine %>% dplyr::select(-c(CommonName, totalCount)) %>% distinct()

# Merge 
Seine_complete <- left_join(Seine_completecase, Seine_samples, by = c("Date", "Survey", "StationCode"))
# There is a Yolo sample with two volumes... this is why there are more rows of Seine_complete

### Calculate CPUE
# Remove samples with no volume 
Seine_CPUE <- Seine_complete %>%
  filter(!is.na(VolumeSampled))%>%
  mutate(CPUE = round(sum.count/VolumeSampled,2))

### Rearrange columns 
Seine_f <- Seine_CPUE[, c("Date", "Year", "fYear" , "Month", "Day", "Survey", "StationCode",                           "Latitude", "Longitude","MethodCode",
                         "WYType", "FlowPulseType", "NetFlowDays","ActionPhase", "Region", "Secchi",  "Conductivity", "WaterTemp", "VolumeSampled",  "CommonName", "sum.count", "CPUE")]

### Mean CPUE 
## Calculate means for each species by year-location-actionphase
CPUE_means_seine_phase <- Seine_f %>%
  group_by(Year, Survey, StationCode, ActionPhase, CommonName) %>% 
  summarize(mean.CPUE = mean(CPUE)) 
```


```{r}
### Mean CPUE 
## Calculate means for each species by year-location-actionphase
CPUE_means_Seine_phase <- Seine_f %>%
  group_by(Year, Survey, StationCode, ActionPhase, CommonName) %>% 
  summarize(mean.CPUE = mean(CPUE)) 
```


## Filter for species sets

```{r Seine filters, warning = FALSE, message = FALSE}
# Lists
list_native <- c("Sacramento Pikeminnow", "Splittail", "Hitch", "Hardhead", "Sacramento Sucker", "Sacramento Blackfish")
list_smeltish <- c("Wakasagi", "Inland Silverside")
list_nmds <- c("Sacramento Pikeminnow", "Splittail", "Hitch", "Hardhead", "Sacramento Sucker", "Sacramento Blackfish",
               "Wakasagi", "Inland Silverside", "Delta Smelt", 
               "Carp", "Goldfish", "Hardhead", "Golden Shiner", "Fathead Minnow", "Hitch",
               "Rainwater Killifish", "Western Mosquitofish", "Black Crappie", "White Crappie", "Bluegill", "Bigscale Logperch",
               "Largemouth Bass", "Smallmouth Bass", "Striped Bass", "Spotted Bass",
               "Threadfin Shad", "American Shad")

Seine_natives0 <- Seine_f %>%filter(CommonName %in% list_native)
Seine_nmds <- Seine_f%>% filter(CommonName %in%list_nmds)
Seine_smeltish0 <- Seine_f %>% filter(CommonName %in% list_smeltish) %>%
  arrange(CommonName, CPUE)
```

## Run Models {.tabset}

### Smeltish

#### Sum smeltish into one CPUE/seine
```{r}
Seine_smeltish <- Seine_smeltish0 %>%
  group_by(Date, Survey, fYear, StationCode, FlowPulseType, ActionPhase, Region, VolumeSampled) %>%
  summarize(sumCPUE = sum(CPUE),
            sumCount = sum(sum.count))
```

#### Look at data

**Pretty much all Silversides (6 Wakasagi caught total)**

* Lots of zeros
* More fish from DJFMP
* No clear pattern Action Phase, Region

```{r}
# Proportion ISS vs Wakasagi
ggplot(Seine_smeltish0, aes(x = fYear, y = CPUE, fill = CommonName)) + geom_col()+ theme_bw()

# Histogram
ggplot(Seine_smeltish, aes(sumCPUE)) + geom_histogram(binwidth = 1) + theme_bw()

# Survey
ggplot(Seine_smeltish, aes(x = Date, y = sumCPUE)) + geom_point() + facet_wrap(Survey~.) + theme_bw()

# Action Phase
ggplot(Seine_smeltish, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Region
ggplot(Seine_smeltish, aes(x = Region, y = sumCPUE)) + geom_jitter(aes(color = ActionPhase), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Year 
ggplot(Seine_smeltish, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + facet_wrap(~fYear) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()
```

# Barplot for final figure 
# Summarize - Mean + Standard Error
```{r}
Seine_summary <- Seine_smeltish %>% 
  group_by(Region, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

plot1 <- ggplot(Seine_summary, aes(x = ActionPhase, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = Region)) + 
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + theme_bw() + 
    annotate("text", x = "Post", y = 12, label = "A", size = 8) + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15),
        legend.position = "bottom")

```

Initial model - QQ plot doesn't look good
```{r}
(M.smeltish1 <- glm(sumCPUE~FlowPulseType + Region + fYear + ActionPhase, data  = Seine_smeltish))
summary(M.smeltish1)
par(mfrow = c(2,2))
plot(M.smeltish1)
```

Using transformations - doesn't work well either
```{r}
(M.smeltish2 <- glm(log(sumCPUE+1)~FlowPulseType + Region + fYear + ActionPhase, data  = Seine_smeltish))
summary(M.smeltish1)
par(mfrow = c(2,2))
plot(M.smeltish1)

logCPUE <-  log(Seine_smeltish$sumCPUE + 1)
hist(logCPUE)
```

#### Zero-inflated model
```{r}
# For CPUE, use offset to account for sampling effort
Seine_smeltish$Samp <- log(Seine_smeltish$VolumeSampled)

# Formula
f1 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))

# Negbin
zinb1 <- zeroinfl(f1, na.action = "na.fail", dist="negbin", link = "logit", data = Seine_smeltish) ; summary(zinb1)

# Poisson
zip1 <- zeroinfl(f1, dist = "poisson", link = "logit", data = Seine_smeltish); summary(zip1)

# Hurdle 
hrd1 <- hurdle(f1, dist="negbin", data = Seine_smeltish); summary(hrd1)

```

Compare zero-inflated poisson, zero-inflated negbin, hurdle
```{r}
library(lmtest)
lrtest(zip1, zinb1)

# check all 3
BIC(zip1, zinb1, hrd1)
```

ZINB is the best. 
Compare zinb with nb, make sure zero inflation is the way to go
```{r}
# No zero inflation
nb1 <- glm.nb(f1,  data = Seine_smeltish) ; summary(nb1) 
vuong(nb1, zinb1)
```
It is. 

#### Diagnostic Plots
https://stackoverflow.com/questions/43075911/examining-residuals-and-visualizing-zero-inflated-poission-r

Rootograms - should like like a typical overdispersed distribution
This compares observed and fitted frequencies
Randomized quantile residuals plot
```{r}
par(mfrow = c(1,2))
rootogram(zinb1, main = "ZINB", ylim = c(-5, 15), max = 50)
qqrplot(zinb1)
```

Distribution of residuals by variable
```{r}
EP1 <- resid(zinb1, type = "pearson")

# Diagnostic Plots
par(mfrow = c(2,2))
plot(x=Seine_smeltish$ActionPhase,y = EP1, main = "Action Phase")
plot(x=Seine_smeltish$Region, y = EP1, main = "Region")
plot(x=Seine_smeltish$fYear, y = EP1, main = "Year")
```

Look at overall relationships
```{r}
par(mfrow = c(2,2))
visreg(zinb1)
```

Post-hoc

```{r}
m_means1 <- emmeans(zinb1, ~fYear)
multcomp::cld(m_means1, Letters = letters)
```


**Conclusions**

* Keep in mind this is mostly Inland Silversides 
* More smeltish downstream, then middle Sac, then upstream
* More smeltish pre, then during, then post
* Years 2013, 2014, 2017 sig lower CPUE; years 2015, 2018 sig higher CPUE; 2016 and 2019 in between 
* More zeros in Middle Sac River, then Downstream, then Upstream
* More zeros Pre vs Post
* Not much year effect on zeros but some variability

### Native fishes

#### Sum natives into one CPUE/seine
```{r}
Seine_natives <- Seine_natives0 %>%
  group_by(Date, Survey, fYear, StationCode, FlowPulseType, ActionPhase, Region, VolumeSampled) %>%
  summarize(sumCPUE = sum(CPUE),
            sumCount = sum(sum.count))
```

#### Look at data

* Good proportions - mostly Sucker, Pikeminnow, some years Splittail
* Lots of zeros, usually low catch when there is catch
* More fish from DJFMP
* More pre, Middle-Sac River

```{r}
# Proportion Species
ggplot(Seine_natives0, aes(x = fYear, y = CPUE, fill = CommonName)) + geom_col()+ theme_bw() + scale_fill_viridis(discrete = TRUE, option = "plasma")

# Histogram
ggplot(Seine_natives, aes(sumCPUE)) + geom_histogram(binwidth = .1) + theme_bw()

# Survey
ggplot(Seine_natives, aes(x = Date, y = sumCPUE)) + geom_point() + facet_wrap(Survey~.) + theme_bw()

# Action Phase
ggplot(Seine_natives, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Region
ggplot(Seine_natives, aes(x = Region, y = sumCPUE)) + geom_jitter(aes(color = ActionPhase), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Year 
ggplot(Seine_natives, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + facet_wrap(~fYear) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()
```

# Barplot
# Summarize - Mean + Standard Error
```{r}
Seine_summary2 <- Seine_natives %>% 
  group_by(Region, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

plot2 <- ggplot(Seine_summary2, aes(x = ActionPhase, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = Region)) + 
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + theme_bw() + 
    annotate("text", x = "Post", y = .2, label = "B", size = 8)  + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15),
        legend.position = "none")
```


#### Zero-inflated model
```{r}
# For CPUE, use offset to account for sampling effort
Seine_natives$Samp <- log(Seine_natives$VolumeSampled)

# Formula
f2 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))

# Negbin
zinb2 <- zeroinfl(f2, na.action = "na.fail", dist="negbin", link = "logit", data = Seine_natives) ; summary(zinb2)

# Poisson
zip2 <- zeroinfl(f2, dist = "poisson", link = "logit", data = Seine_natives); summary(zip2)

# Hurdle
hrd2 <- hurdle(f2, dist="negbin", data = Seine_natives); summary(hrd2)
```

Compare zero-inflated poisson with zero-inflated negbin
```{r}
library(lmtest)
lrtest(zip2, zinb2)
# Significantly different 

BIC(zip2, zinb2, hrd2)
```

ZINB is the best. 
Compare zinb with nb, make sure zero inflation is the way to go
```{r}
# No zero inflation
nb2 <- glm.nb(f2,  data = Seine_natives) ; summary(nb2) 
vuong(nb2, zinb2)
```
This is unclear. 

#### Diagnostic Plots

Rootograms - should like like a typical overdispersed distribution
This compares observed and fitted frequencies
qqrplot
```{r}
par(mfrow = c(1,2))
rootogram(zinb2, main = "ZINB", ylim = c(-5, 15), max = 50)
qqrplot(zinb2)
```

Distribution of residuals by variable
```{r}

# Calculate residuals
EP2 <- resid(zinb2, type = "pearson")

# Diagnostic Plots
par(mfrow = c(2,2))
plot(x=Seine_natives$ActionPhase,y = EP2, main = "Action Phase")
plot(x=Seine_natives$Region, y = EP2, main = "Region")
plot(x=Seine_natives$fYear, y = EP2, main = "Year")

levels(Seine_natives$fYear)
```

View Results
```{r}
par(mfrow = c(2,2))
visreg(zinb2)
```

Post-hoc
```{r}
m_means2 <- emmeans(zinb2, ~fYear)
multcomp::cld(m_means2, Letters = letters)
```

```{r}
Seine_summary3 <- Seine_natives %>% 
  group_by(ActionPhase, Region) %>%
  mutate(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) %>%
  ungroup() %>%
  group_by(fYear, ActionPhase) %>%
  summarize(meanCPUE2 = mean(meanCPUE))

Seine_summary4 <- Seine_natives %>% 
  group_by(Region, fYear) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 


ggplot(Seine_summary3, aes(x = fYear, y = ActionPhase, fill = meanCPUE2)) + geom_tile() + scale_fill_viridis()

ggplot(Seine_summary4, aes(x = fYear, y = Region, fill = meanCPUE)) + geom_tile() + scale_fill_viridis()
```



**Conclusions**

* More natives Middle Sac > Downstream > Upstream
* More natives Pre > Post > During
* 2016, 2019 higher CPUE > 2013, 2017, 2018 > 2014, 2015
* More zeros Downstream > Middle Sac > Upstream
* More zeros Pre>post




### Overall CPUE
* Not zero-inflated

#### Sum Overall CPUE
```{r}
Seine_all <- Seine_f %>%
  group_by(Survey,fYear, Date, Region, StationCode, ActionPhase, MethodCode, VolumeSampled) %>%
  summarize(sumCPUE = sum(CPUE),
            sumCount = sum(sum.count))
```

#### Look at data  

* Lots of silversides
* Definite overdispersion
* More catch DJFMP
* Doesn't look uch different between phases, but a few high catches in Pre
* More downstream

```{r}
# Proportion Species
ggplot(Seine_f, aes(x = fYear, y = CPUE, fill = CommonName)) + geom_col()+ theme_bw()  + theme(legend.position = "bottom")

# Histogram
ggplot(Seine_all, aes(sumCPUE)) + geom_histogram(binwidth = .1) + theme_bw()

# Survey
ggplot(Seine_all, aes(x = Date, y = sumCPUE)) + geom_point() + facet_wrap(Survey~.) + theme_bw()

# Action Phase
ggplot(Seine_all, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Region
ggplot(Seine_all, aes(x = Region, y = sumCPUE)) + geom_jitter(aes(color = ActionPhase), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Year 
ggplot(Seine_all, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + facet_wrap(~fYear) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()
```

# Barplot
# Summarize - Mean + Standard Error
```{r}
Seine_summary3 <- Seine_all %>% 
  group_by(Region, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

# Order Action Phases
Fish_all$ActionPhase <- as.factor(Fish_all$ActionPhase)
Seine_all$ActionPhase <-  factor(Seine_all$ActionPhase, levels(Seine_all$ActionPhase)[c(1, 2, 3)])

plot3 <- ggplot(Seine_summary3, aes(x = ActionPhase, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = Region)) + 
  
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + theme_bw() + 
  annotate("text", x = "Post", y = 14, label = "C", size = 8)  + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15),
        legend.position = "none")



```

Merge plots - keep working

https://github.com/tidyverse/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs
```{r}

library(gridExtra)
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

legend <- get_legend(plot1)
plot1 <- plot1 + theme(legend.position = "none")
grid.arrange(plot1, plot2, plot3, legend)
grid.arrange(arrangeGrob(plot1, plot4, plot2, top = "Seine"), arrangeGrob(plot5, plot3, plot6, top = "Tow"), legend, ncol = 2)
```


#### Model - normal glm
```{r}
m1all <- glm(sumCPUE~Region + fYear + ActionPhase, data = Seine_all); summary(m1all)

par(mfrow = c(2,2))
plot(m1all)

```

#### Model with log transformation
```{r}
Seine_all$logCPUE = log(Seine_all$sumCPUE + 1)
m2all <- glm(logCPUE~Region + fYear + ActionPhase, data = Seine_all); summary(m2all)

par(mfrow = c(2,2))
plot(m2all)

hist(Seine_all$logCPUE)
```

#### Model with poisson distribution
```{r}
# For CPUE, use offset to account for sampling effort
Seine_all$Samp <- log(Seine_all$VolumeSampled)

# Formula
f3 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))

# Check overdispersion (var>mean)
var(Seine_all$sumCPUE)
mean(Seine_all$sumCPUE)


# Poisson distribution or quasipoisson (overdispersed)
m3all <- glm(f3, data = Seine_all, family = poisson); summary(m3all)

# Model dispersion
deviance(m3all)/m3all$df.residual # very overdispersed


```

#### Model with negative binomial distribution
* https://stats.idre.ucla.edu/r/dae/negative-binomial-regression/
```{r}
m4all <- glm.nb(f3, data = Seine_all); summary(m4all)

# Confidence Intervals 
(est <- cbind(Estimate = coef(m4all), confint(m4all)))

# Incidence Rates (Count)
exp(est)
```

# Compare the two
```{r}
BIC(m3all, m4all)
```
Negative Binomial preferred.

#### Diagnostic Plots

Rootogram and qqrplot
```{r}
par(mfrow = c(1,2))
rootogram(m4all)
qqrplot(m4all)
```

Plot residuals
```{r}
# Diagnostic Plots -------------------------------------
# Model Validation 
# Calculate residuals
EP3 <- resid(m4all, type = "pearson")

# Diagnostic Plots
par(mfrow = c(2,2))
plot(x=m4all$fitted.values, y = EP3, main = "Pearson residuals")
plot(x=Seine_all$ActionPhase,y = EP3, main = "Action Phase")
plot(x=Seine_all$Region, y = EP3, main = "Region")
plot(x=Seine_all$fYear, y = EP3, main = "Year")

```

View plot
```{r}
par(mfrow = c(2,2))
visreg(m4all)
```

Post-hoc

```{r}
m_means3 <- emmeans(m4all, ~fYear)
multcomp::cld(m_means3, Letters = letters)
```

**Conclusions**

* Still not sure about residual distribution
* More fish Downstream > Upstream > Middle Sac
* More fish Pre > Post 
* Years: highest 2015, 2017-2019, 2016, 2013, 2014
