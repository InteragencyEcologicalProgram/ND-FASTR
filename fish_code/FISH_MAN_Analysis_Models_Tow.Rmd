---
title: "FISH_MAN_Analysis_Models_Tow"
author: "Catarina Pien"
date: "12/15/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

Code for FASTR fish models for tow data
Fish ~ Region + Action Phase + Year

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages
```{r load, echo = FALSE, results = FALSE, warning = FALSE, message = FALSE}

rm(list=ls(all=TRUE))

library(tidyverse)
library(lubridate) # Datetime
library(pscl) # Run zips and zinbs
library(visreg) # Visualize models
library(dplyr)
```

## Import data
* Fish_ndfa: integrated fish dataset
* FlowDesignation: Assigns action phases by date
* Regions: Assigns regions to fish stations
* Merge all together
* Define variable structures
* Order action phases

```{r import and filter dates, warning = FALSE, message = FALSE, results = FALSE}
setwd("C:/Users/cpien/OneDrive - California Department of Water Resources/Work/FASTR/FASTR/ND-FASTR")
Fish_ndfa_0 <- read.csv("fish data/FISH_MAN_allIEPsurveys_20201030.csv")
Fish_ndfa <- select(Fish_ndfa_0, -c(Latitude, Longitude, DO, Turbidity))
FlowDesignation <- read.csv("fish data/FlowDatesDesignations_45days.csv")
Regions <- read.csv("fish data/Stations_Fish_NDFA_2021-01-13.csv")
Regions_min <- Regions %>%
  rename(Survey = Survey.x) %>%
  select(-c(Intersect, geometry, RegionMult))

# Look at data
head(Fish_ndfa)
str(Fish_ndfa)

# Add variables
Fish_ndfa$Date <- ymd(Fish_ndfa$Date)
Fish_ndfa$Month <- month(Fish_ndfa$Date)
Fish_ndfa$Day <- day(Fish_ndfa$Date)
FlowDesignation$PreFlowStart <- mdy(FlowDesignation$PreFlowStart)
FlowDesignation$PreFlowEnd <- mdy(FlowDesignation$PreFlowEnd)
FlowDesignation$PostFlowStart <- mdy(FlowDesignation$PostFlowStart)
FlowDesignation$PostFlowEnd <- mdy(FlowDesignation$PostFlowEnd)

# Merge data from FlowDesignation Table (Water Year Type, Flow days and type)
# Filter only Pre-During-Post Flow Action Data. 
# We have a during action, and then Pre = 30 days before/Post = 30 days after
Fish_all0 <- inner_join(Fish_ndfa,FlowDesignation, by = "Year")
Fish_all1 <- left_join(Fish_all0, Regions_min, by = c("StationCode", "Survey"))

# anti_join(Fish_all1, Fish_all0, by = colnames(Fish_all0))

Fish_all <- Fish_all1 %>%
   mutate(ActionPhase = ifelse(Date > PreFlowStart & Date<PreFlowEnd, "Pre", NA)) %>%
   mutate(ActionPhase = replace(ActionPhase, Date > PreFlowEnd & Date < PostFlowStart, "During")) %>% 
   mutate(ActionPhase = replace(ActionPhase, Date > PostFlowStart & Date < PostFlowEnd, "Post")) %>%
  filter(!is.na(ActionPhase)) %>%
   select(-c(PreFlowStart:PostFlowEnd)) %>%
   arrange(Date, Survey, StationCode, CommonName)


# Order Action Phases
Fish_all$ActionPhase <- as.factor(Fish_all$ActionPhase)
Fish_all$ActionPhase <-  factor(Fish_all$ActionPhase, levels(Fish_all$ActionPhase)[c(3,1,2)])

# Define variable structures
str(Fish_all)

Fish_all$Date <- ymd(Fish_all$Date)
Fish_all$fMonth <- ordered(Fish_all$Month)
Fish_all$fYear <- ordered(Fish_all$Year)
Fish_all$WYType <- as.factor(Fish_all$WYType)
Fish_all$FlowPulseType <- as.factor(Fish_all$FlowPulseType)
Fish_all$ActionPhase <- as.factor(Fish_all$ActionPhase)
Fish_all$X1 <- NULL
Fish_all$Survey <- as.factor(Fish_all$Survey)
Fish_all$StationCode <- as.factor(Fish_all$StationCode)
Fish_all$MethodCode <- as.factor(Fish_all$MethodCode)
Fish_all$Region <- as.factor(Fish_all$Region)

str(Fish_all)

```


## Data Prep
* Filter to just tow data and year starting 2013
* Fill in zeros for unlisted species using complete cases
* Calculate CPUE 
* Organize data

```{r seine, warning = FALSE, message = FALSE}
# Filter Dataset
Tow <- Fish_all %>% 
  filter(Survey %in% c("EDSM", "Townet", "FMWT")) %>%
  filter(Year>2012) %>%
  arrange(Survey, Date, StationCode, Tow, Depth)

### Complete Cases
# For each Date, Survey, StationCode combination, make sure each fish species is represented with either positive count or zero. 
Tow_completecase <- Tow %>%
  group_by(Date, Survey, StationCode, Tow, Depth, CommonName) %>%
  summarize(sum.count = sum(totalCount)) %>%
  ungroup() %>%
  complete(CommonName, nesting(Date, Survey, StationCode, Tow, Depth), fill = list(sum.count = 0)) %>%
  arrange(Date, Survey, StationCode,CommonName)

### Merge back together with rest of data

# Get distinct samples for looking at Water Quality 
Tow_samples <- Tow %>% select(-c(CommonName, totalCount)) %>% distinct()

# Merge 
Tow_complete <- left_join(Tow_completecase, Tow_samples, by = c("Date", "Survey", "StationCode", "Tow", "Depth"))

### Calculate CPUE
# Remove samples with no volume 
Tow_CPUE <- Tow_complete %>%
  filter(!is.na(VolumeSampled))%>%
  mutate(CPUE = sum.count/VolumeSampled)

### Rearrange columns 
Tow_f <- Tow_CPUE[, c("Date", "Year", "fYear", "Month", "Day", "Survey", "StationCode", "Latitude", "Longitude","Region","MethodCode", "WYType", "FlowPulseType", "NetFlowDays","ActionPhase", "Secchi",  "Conductivity", "WaterTemp",  "Tow", "Depth", "VolumeSampled",  "CommonName", "sum.count", "CPUE")]
```


```{r}
### Mean CPUE 
## Calculate means for each species by year-location-actionphase
CPUE_means_Tow_phase <- Tow_f %>%
  group_by(Year, Survey, StationCode, Tow, ActionPhase, CommonName) %>% 
  summarize(mean.CPUE = mean(CPUE)) 
```

## Filter for species sets

```{r Tow filters, warning = FALSE, message = FALSE}
# Lists
list_native <- c("Sacramento Pikeminnow", "Splittail", "Hitch", "Hardhead", "Sacramento Sucker", "Sacramento Blackfish")
list_smeltish <- c("Wakasagi", "Inland Silverside")
list_nmds <- c("Sacramento Pikeminnow", "Splittail", "Hitch", "Hardhead", "Sacramento Sucker", "Sacramento Blackfish","Wakasagi", "Inland Silverside", "Delta Smelt", "Carp", "Goldfish", "Hardhead", "Golden Shiner", "Fathead Minnow", "Hitch","Rainwater Killifish", "Western Mosquitofish", "Black Crappie", "White Crappie", "Bluegill", "Bigscale Logperch","Largemouth Bass", "Smallmouth Bass", "Striped Bass", "Spotted Bass","Threadfin Shad", "American Shad", "Tridentiger spp_", "Shimofuri Goby", "White Catfish")

Tow_natives0 <- Tow_f %>%filter(CommonName %in% list_native)
Tow_nmds_larger <- Tow_f%>% filter(CommonName %in%list_nmds)
Tow_smeltish0 <- Tow_f %>% filter(CommonName %in% list_smeltish)
```

## Run ANOVA {.tabset}

### Smeltish

Sum smeltish into one CPUE/Tow
```{r}
Tow_smeltish <- Tow_smeltish0 %>%
  group_by(Survey, fYear, StationCode, FlowPulseType, ActionPhase, Region, Date,  VolumeSampled, Tow) %>%
  summarize(sumCPUE = sum(CPUE),
            sumCount = sum(sum.count))
```

Look at data

* Mostly silversides
* More fish from EDSM
* More upstream

```{r}
# Proportion ISS vs Wakasagi
ggplot(Tow_smeltish0, aes(x = fYear, y = CPUE, fill = CommonName)) + geom_col()+ theme_bw()

# Histogram
ggplot(Tow_smeltish, aes(sumCPUE)) + geom_histogram(binwidth = .001) + theme_bw()

# Survey
ggplot(Tow_smeltish, aes(x = Date, y = sumCPUE)) + geom_point() + facet_wrap(Survey~.) + theme_bw()

# Action Phase
ggplot(Tow_smeltish, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Region
ggplot(Tow_smeltish, aes(x = Region, y = sumCPUE)) + geom_jitter(aes(color = ActionPhase), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Year 
ggplot(Tow_smeltish, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + facet_wrap(~fYear) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()
```

Using transformations - doesn't work well
```{r}
(M.smeltish1 <- glm(log(sumCPUE+1)~FlowPulseType + ActionPhase + Region, data  = Tow_smeltish))
summary(M.smeltish1)
par(mfrow = c(2,2))
plot(M.smeltish1)
```

Zero-inflated model
```{r}

# For CPUE, use offset to account for sampling effort
Tow_smeltish$Samp <- log(Tow_smeltish$VolumeSampled)

# Formula
f1 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))

# Overdispersion = Variance much larger than mean. 
var(Tow_smeltish$sumCount)
mean(Tow_smeltish$sumCount)

# Negbin
zinb1 <- zeroinfl(f1, na.action = "na.fail", dist="negbin", link = "logit", data = Tow_smeltish) ; summary(zinb1)

# Poisson
zip1 <- zeroinfl(f1, dist = "poisson", link = "logit", data = Tow_smeltish); summary(zip1)
```

Compare zero-inflated poisson with zero-inflated negbin using likelihood ratio test

**Confused about what this test is telling me. I use negbin if the test is significant?**
```{r}
library(lmtest)
lrtest(zip1, zinb1)

# Significantly different 
```

Diagnostic Plots

```{r}
# Diagnostic Plots -------------------------------------
# Model Validation 
# Calculate residuals
EP1 <- resid(zinb1, type = "pearson")

# Diagnostic Plots
par(mfrow = c(2,2))
plot(x=zinb1$fitted.values, y = EP1, main = "Pearson residuals")
# qqrplot(EP1) # Don't know why not working
plot(x=Tow_smeltish$ActionPhase,y = EP1, main = "Resid vs Action Phase")
plot(x=Tow_smeltish$Region, y = EP1, main = "Resid vs Region")
plot(x=Tow_smeltish$fYear, y = EP1, main = "Resid vs Year")

par(mfrow = c(2,2))
visreg(zinb1)
```

**Conclusions**

* More smeltish post>pre>during (but very small difference)
* More smeltish upstream>downstream
* Variability by year
* More zeroes upstream than downstream
* More zeroes during than pre



### Native fishes

Sum natives into one CPUE/tow
```{r}
Tow_natives <- Tow_natives0 %>%
  group_by(Date, Survey, fYear, StationCode, FlowPulseType, ActionPhase, Region, VolumeSampled, Tow) %>%
  summarize(sumCPUE = sum(CPUE),
            sumCount = sum(sum.count))
```

Look at plots

* Very little catch
```{r}
# Proportion Species
ggplot(Tow_natives0, aes(x = fYear, y = CPUE, fill = CommonName)) + geom_col()+ theme_bw() + scale_fill_viridis(discrete = TRUE, option = "plasma")

# Histogram
ggplot(Tow_natives, aes(sumCPUE)) + geom_histogram(binwidth = .0001) + theme_bw()

# Survey
ggplot(Tow_natives, aes(x = Date, y = sumCPUE)) + geom_point() + facet_wrap(Survey~.) + theme_bw()

# Action Phase
ggplot(Tow_natives, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Region
ggplot(Tow_natives, aes(x = Region, y = sumCPUE)) + geom_jitter(aes(color = ActionPhase), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Year 
ggplot(Tow_natives, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + facet_wrap(~fYear) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()
```

Zero-inflated model
* Doesn't work - not enough samples?
```{r}

# For CPUE, use offset to account for sampling effort
Tow_natives$Samp <- log(Tow_natives$VolumeSampled)

# Formula
f2 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))

# Negbin
zinb2 <- zeroinfl(f2, na.action = "na.fail", dist="negbin", link = "logit", data = Tow_natives) ; summary(zinb2)

# Poisson
zip2 <- zeroinfl(f2, dist = "poisson", link = "logit", data = Tow_natives); summary(zip2)
```

Compare zero-inflated poisson with zero-inflated negbin
```{r}
library(lmtest)
lrtest(zip2, zinb2)
```

Diagnostic Plots
```{r}
# Diagnostic Plots -------------------------------------
# Model Validation 
# Calculate residuals
EP2 <- resid(zinb2, type = "pearson")

# Diagnostic Plots
par(mfrow = c(2,2))
plot(x=zinb2$fitted.values, y = EP2, main = "Pearson residuals")
# qqrplot(EP2) # Don't know why not working
plot(x=Tow_natives$ActionPhase,y = EP2, main = "Action Phase")
plot(x=Tow_natives$Region, y = EP2, main = "Region")
plot(x=Tow_natives$fYear, y = EP2, main = "Year")

par(mfrow = c(2,2))
visreg(zinb2)
```

### Overall CPUE

Sum Overall CPUE
```{r}
Tow_all <- Tow_f %>%
  group_by(Survey,fYear, Date, Region, StationCode, ActionPhase, MethodCode, VolumeSampled, Tow) %>%
  summarize(sumCPUE = sum(CPUE),
            sumCount = sum(sum.count))
```

Look at data


```{r}
# Proportion Species
ggplot(Tow_f, aes(x = fYear, y = CPUE, fill = CommonName)) + geom_col()+ theme_bw()  + theme(legend.position = "bottom")

# Histogram
ggplot(Tow_all, aes(sumCPUE)) + geom_histogram(binwidth = .001) + theme_bw()

# Survey
ggplot(Tow_all, aes(x = Date, y = sumCPUE)) + geom_point() + facet_wrap(Survey~.) + theme_bw()

# Action Phase
ggplot(Tow_all, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Region
ggplot(Tow_all, aes(x = Region, y = sumCPUE)) + geom_jitter(aes(color = ActionPhase), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Year 
ggplot(Tow_all, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + facet_wrap(~fYear) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()
```

Model - normal glm
```{r}
m1all <- glm(sumCPUE~Region + fYear + ActionPhase, data = Tow_all); summary(m1all)

par(mfrow = c(2,2))
plot(m1all)

```

Model with log transformation
```{r}
Tow_all$logCPUE = log(Tow_all$sumCPUE + 1)
m2all <- glm(logCPUE~Region + fYear + ActionPhase, data = Tow_all); summary(m2all)

par(mfrow = c(2,2))
plot(m2all)

hist(Tow_all$logCPUE)
```

Model with poisson distribution
```{r}

# For CPUE, use offset to account for sampling effort
Tow_all$Samp <- log(Tow_all$VolumeSampled)

# Formula
f3 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))

# Check overdispersion (var>mean)
var(Tow_all$sumCPUE)
mean(Tow_all$sumCPUE)

# Poisson distribution or quasipoisson (overdispersed)
m3all <- glm(f3, data = Tow_all, family = quasipoisson); summary(m3all)
# See dispersion parameter

par(mfrow = c(2,2))
plot(m3all)

visreg(m3all)
```

Model with negative binomial distribution
* https://stats.idre.ucla.edu/r/dae/negative-binomial-regression/
```{r}
library(MASS)
m4all <- glm.nb(f3, data = Tow_all); summary(m4all)
plot(m4all)

# Confidence Intervals 
(est <- cbind(Estimate = coef(m4all), confint(m4all)))

# Incidence Rates (Count)
exp(est)
```

Diagnostic Plots
```{r}
# Diagnostic Plots -------------------------------------
# Model Validation 
# Calculate residuals
EP3 <- resid(m4all, type = "pearson")

# Diagnostic Plots
par(mfrow = c(2,2))
plot(x=m4all$fitted.values, y = EP3, main = "Pearson residuals")
plot(x=Tow_all$ActionPhase,y = EP3, main = "Action Phase")
plot(x=Tow_all$Region, y = EP3, main = "Region")
plot(x=Tow_all$fYear, y = EP3, main = "Year")

par(mfrow = c(2,2))
visreg(m4all)
```

**Conclusions**

* More samples in 2017-2019 (EDSM started?) 
* Not sure about residual distribution
* More fish Upstream > Downstream > Middle Sac
* More fish Pre > Post > During 
* Year variability - not sure if reading correctly (compare plot vs numbers)
