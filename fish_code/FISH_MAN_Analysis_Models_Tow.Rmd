---
title: "FISH_MAN_Analysis_Models_Tow"
author: "Catarina Pien"
date: "12/15/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

Code for FASTR fish models for tow data
Fish ~ Region + Action Phase + Year

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages
```{r load, echo = FALSE, results = FALSE, warning = FALSE, message = FALSE}

rm(list=ls(all=TRUE))

library(tidyverse)
library(lubridate) # Datetime
library(pscl) # Run zips and zinbs
library(visreg) # Visualize models
library(viridis) # Color palette
library(emmeans) # post hoc
library(MASS) # negbin modelv
library(countreg) # zeroinfl and hurdle functions, qqrplot
library(gridExtra)
library(grid)
library(dplyr)
```

## Import data
* Fish_ndfa: integrated fish dataset
* FlowDesignation: Assigns action phases by date
* Regions: Assigns regions to fish stations
* Merge all together
* Define variable structures
* Order action phases

```{r import and filter dates, warning = FALSE, message = FALSE, results = FALSE}
setwd("C:/Users/cpien/OneDrive - California Department of Water Resources/Work/FASTR/FASTR/ND-FASTR")
Fish_ndfa_0 <- read.csv("fish data/FISH_MAN_allIEPsurveys_20201030.csv")
Fish_ndfa <- dplyr::select(Fish_ndfa_0, -c(Latitude, Longitude, DO, Turbidity))
FlowDesignation <- read.csv("fish data/FlowDatesDesignations_45days.csv")
Regions <- read.csv("fish data/Stations_Fish_NDFA_2021-01-13.csv")
Regions_min <- Regions %>%
  rename(Survey = Survey.x) %>%
  dplyr::select(-c(Intersect, geometry, RegionMult))

# Look at data
head(Fish_ndfa)
str(Fish_ndfa)

# Add variables
Fish_ndfa$Date <- ymd(Fish_ndfa$Date)
Fish_ndfa$Month <- month(Fish_ndfa$Date)
Fish_ndfa$Day <- day(Fish_ndfa$Date)
FlowDesignation$PreFlowStart <- mdy(FlowDesignation$PreFlowStart)
FlowDesignation$PreFlowEnd <- mdy(FlowDesignation$PreFlowEnd)
FlowDesignation$PostFlowStart <- mdy(FlowDesignation$PostFlowStart)
FlowDesignation$PostFlowEnd <- mdy(FlowDesignation$PostFlowEnd)

# Merge data from FlowDesignation Table (Water Year Type, Flow days and type)
# Filter only Pre-During-Post Flow Action Data. 
# We have a during action, and then Pre = 30 days before/Post = 30 days after
Fish_all0 <- inner_join(Fish_ndfa,FlowDesignation, by = "Year")
Fish_all1 <- left_join(Fish_all0, Regions_min, by = c("StationCode", "Survey"))

# anti_join(Fish_all1, Fish_all0, by = colnames(Fish_all0))

Fish_all <- Fish_all1 %>%
   mutate(ActionPhase = ifelse(Date > PreFlowStart & Date<PreFlowEnd, "Pre", NA)) %>%
   mutate(ActionPhase = replace(ActionPhase, Date > PreFlowEnd & Date < PostFlowStart, "During")) %>% 
   mutate(ActionPhase = replace(ActionPhase, Date > PostFlowStart & Date < PostFlowEnd, "Post")) %>%
  filter(!is.na(ActionPhase)) %>%
   dplyr::select(-c(PreFlowStart:PostFlowEnd)) %>%
   arrange(Date, Survey, StationCode, CommonName)


# Order Action Phases
Fish_all$ActionPhase <- as.factor(Fish_all$ActionPhase)
Fish_all$ActionPhase <-  factor(Fish_all$ActionPhase, levels(Fish_all$ActionPhase)[c(3,1,2)])

# Define variable structures
str(Fish_all)

Fish_all$Date <- ymd(Fish_all$Date)
Fish_all$fMonth <- as.factor(Fish_all$Month)
Fish_all$fYear <- as.factor(Fish_all$Year)
Fish_all$WYType <- as.factor(Fish_all$WYType)
Fish_all$FlowPulseType <- as.factor(Fish_all$FlowPulseType)
Fish_all$ActionPhase <- as.factor(Fish_all$ActionPhase)
Fish_all$X1 <- NULL
Fish_all$Survey <- as.factor(Fish_all$Survey)
Fish_all$StationCode <- as.factor(Fish_all$StationCode)
Fish_all$MethodCode <- as.factor(Fish_all$MethodCode)
Fish_all$Region <- factor(Fish_all$Region, levels = c("Upstream", "Downstream", "MiddleSacRiver"))

str(Fish_all)

```


## Data Prep
* Filter to just tow data and year starting 2013
* Fill in zeros for unlisted species using complete cases
* Calculate CPUE 
* Organize data

```{r tow, warning = FALSE, message = FALSE}
# Filter Dataset
Tow <- Fish_all %>% 
  filter(Survey %in% c("EDSM", "Townet", "FMWT")) %>%
  filter(Year>2012) %>%
  arrange(Survey, Date, StationCode, Tow, Depth)

### Complete Cases
# For each Date, Survey, StationCode combination, make sure each fish species is represented with either positive count or zero. 
Tow_completecase <- Tow %>%
  group_by(Date, Survey, StationCode, Tow, Depth, CommonName) %>%
  summarize(sum.count = sum(totalCount)) %>%
  ungroup() %>%
  complete(CommonName, nesting(Date, Survey, StationCode, Tow, Depth), fill = list(sum.count = 0)) %>%
  arrange(Date, Survey, StationCode,CommonName)

### Merge back together with rest of data

# Get distinct samples for looking at Water Quality 
Tow_samples <- Tow %>% dplyr::select(-c(CommonName, totalCount)) %>% distinct()

# Merge 
Tow_complete <- left_join(Tow_completecase, Tow_samples, by = c("Date", "Survey", "StationCode", "Tow", "Depth"))

### Calculate CPUE
# Remove samples with no volume 
Tow_CPUE <- Tow_complete %>%
  filter(!is.na(VolumeSampled))%>%
  mutate(CPUE = sum.count/VolumeSampled)

### Rearrange columns 
Tow_f <- Tow_CPUE[, c("Date", "Year", "fYear", "Month", "Day", "Survey", "StationCode", "Latitude", "Longitude","Region","MethodCode", "WYType", "FlowPulseType", "NetFlowDays","ActionPhase", "Secchi",  "Conductivity", "WaterTemp",  "Tow", "Depth", "VolumeSampled",  "CommonName", "sum.count", "CPUE")]
```


```{r}
### Mean CPUE 
## Calculate means for each species by year-location-actionphase
CPUE_means_Tow_phase <- Tow_f %>%
  group_by(Year, Survey, StationCode, Tow, ActionPhase, CommonName) %>% 
  summarize(mean.CPUE = mean(CPUE)) 
```

## Filter for species sets

```{r Tow filters, warning = FALSE, message = FALSE}
# Lists
list_native <- c("Sacramento Pikeminnow", "Splittail", "Hitch", "Hardhead", "Sacramento Sucker", "Sacramento Blackfish")
list_smeltish <- c("Wakasagi", "Inland Silverside")
list_nmds <- c("Sacramento Pikeminnow", "Splittail", "Hitch", "Hardhead", "Sacramento Sucker", "Sacramento Blackfish","Wakasagi", "Inland Silverside", "Delta Smelt", "Carp", "Goldfish", "Hardhead", "Golden Shiner", "Fathead Minnow", "Hitch","Rainwater Killifish", "Western Mosquitofish", "Black Crappie", "White Crappie", "Bluegill", "Bigscale Logperch","Largemouth Bass", "Smallmouth Bass", "Striped Bass", "Spotted Bass","Threadfin Shad", "American Shad", "Tridentiger spp_", "Shimofuri Goby", "White Catfish")

Tow_natives0 <- Tow_f %>%filter(CommonName %in% list_native)
Tow_nmds_larger <- Tow_f%>% filter(CommonName %in%list_nmds)
Tow_smeltish0 <- Tow_f %>% filter(CommonName %in% list_smeltish)
```

## Run Models {.tabset}

### Smeltish

#### Sum smeltish into one CPUE/Tow
```{r}
Tow_smeltish <- Tow_smeltish0 %>%
  group_by(Survey, fYear, StationCode, FlowPulseType, ActionPhase, Region, Date,  VolumeSampled, Tow) %>%
  summarize(sumCPUE = sum(CPUE),
            sumCount = sum(sum.count))
```

#### Look at data

* Mostly silversides
* More fish from EDSM
* More upstream

```{r}
# Proportion ISS vs Wakasagi
ggplot(Tow_smeltish0, aes(x = fYear, y = CPUE, fill = CommonName)) + geom_col()+ theme_bw()

# Histogram
ggplot(Tow_smeltish, aes(sumCPUE)) + geom_histogram(binwidth = .001) + theme_bw()

# Survey
ggplot(Tow_smeltish, aes(x = Date, y = sumCPUE)) + geom_point() + facet_wrap(Survey~.) + theme_bw()

# Action Phase
ggplot(Tow_smeltish, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Region
ggplot(Tow_smeltish, aes(x = Region, y = sumCPUE)) + geom_jitter(aes(color = ActionPhase), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Year 
ggplot(Tow_smeltish, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + facet_wrap(~fYear) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()
```

# Barplot
# Summarize - Mean + Standard Error
```{r}
Tow_summary1 <- Tow_smeltish %>% 
  group_by(Region, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

plot4 <- ggplot(Tow_summary1, aes(x = ActionPhase, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = Region)) + 
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + theme_bw() + 
    annotate("text", x = "Post", y = .006, label = "D", size = 8)  + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15))

```

#### Using transformations - doesn't work well
```{r}
(M.smeltish1 <- glm(log(sumCPUE+1)~FlowPulseType + ActionPhase + Region, data  = Tow_smeltish))
summary(M.smeltish1)
par(mfrow = c(2,2))
plot(M.smeltish1)
```

#### Zero-inflated model
```{r}
# For CPUE, use offset to account for sampling effort
Tow_smeltish$Samp <- log(Tow_smeltish$VolumeSampled)

# Formula
f1 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))
f4 <- formula(sumCount ~ Region + fYear + ActionPhase + Region:ActionPhase+  offset(Samp))
f5 <- formula(sumCount ~ Region + fYear + ActionPhase + Region:fYear+  offset(Samp))
f6 <- formula(sumCount ~ Region + fYear + ActionPhase + ActionPhase:fYear+  offset(Samp))

# Overdispersion = Variance much larger than mean. 
var(Tow_smeltish$sumCount)
mean(Tow_smeltish$sumCount)

# Negbin
zinb1 <- zeroinfl(f1, na.action = "na.fail", dist="negbin", link = "logit", data = Tow_smeltish) ; summary(zinb1)

# Poisson
zip1 <- zeroinfl(f1, dist = "poisson", link = "logit", data = Tow_smeltish); summary(zip1)

# Hurdle 
hrd1 <- hurdle(f1, dist="negbin", data = Tow_smeltish); summary(hrd1)

```

Compare zero-inflated poisson with zero-inflated negbin using likelihood ratio test

**Confused about what this test is telling me. I use negbin if the test is significant?**
```{r}
library(lmtest)
lrtest(zip1, zinb1)

# Significantly different 

# check all 3
BIC(zip1, zinb1, hrd1)
```
ZINB is the best. 
Compare zinb with nb, make sure zero inflation is the way to go
Compare zinb with nb, make sure zero inflation is the way to go
```{r}
# No zero inflation
nb1 <- glm.nb(f1,  data = Tow_smeltish) ; summary(nb1) 
vuong(nb1, zinb1)
```
It is. 

#### Diagnostic Plots

https://stackoverflow.com/questions/43075911/examining-residuals-and-visualizing-zero-inflated-poission-r

Rootograms - should like like a typical overdispersed distribution
This compares observed and fitted frequencies
QQRplot
```{r}
par(mfrow = c(1,2))
rootogram(zinb1, main = "ZINB", ylim = c(-5, 15), max = 50)
qqrplot(zinb1)
```

Distribution of residuals by variable
```{r}
EP1 <- resid(zinb1, type = "pearson")

# Diagnostic Plots
par(mfrow = c(2,2))
plot(x=Tow_smeltish$ActionPhase,y = EP1, main = "Action Phase")
plot(x=Tow_smeltish$Region, y = EP1, main = "Region")
plot(x=Tow_smeltish$fYear, y = EP1, main = "Year")
```

Look at overall relationships
```{r}
par(mfrow = c(2,2))
visreg(zinb1)
```

Post-hoc

```{r}
m_means1 <- emmeans(zinb1, ~fYear)
multcomp::cld(m_means1, Letters = letters)
```

**Conclusions**

* More smeltish post>pre>during (but very small difference)
* More smeltish upstream>downstream
* 2016, 2017, 2019 > 2013> 2018> 2014-2015
* More zeroes upstream than downstream
* More zeroes during than pre


### Native fishes

**Couldn't really run these because not enough data?**

#### Sum natives into one CPUE/tow
```{r}
Tow_natives <- Tow_natives0 %>%
  group_by(Date, Survey, fYear, StationCode, FlowPulseType, ActionPhase, Region, VolumeSampled, Tow) %>%
  summarize(sumCPUE = sum(CPUE),
            sumCount = sum(sum.count))
```

Look at plots

* Very little catch
```{r}
# Proportion Species
ggplot(Tow_natives0, aes(x = fYear, y = CPUE, fill = CommonName)) + geom_col()+ theme_bw() + scale_fill_viridis(discrete = TRUE, option = "plasma")

# Histogram
ggplot(Tow_natives, aes(sumCPUE)) + geom_histogram(binwidth = .0001) + theme_bw()

# Survey
ggplot(Tow_natives, aes(x = Date, y = sumCPUE)) + geom_point() + facet_wrap(Survey~.) + theme_bw()

# Action Phase
ggplot(Tow_natives, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Region
ggplot(Tow_natives, aes(x = Region, y = sumCPUE)) + geom_jitter(aes(color = ActionPhase), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Year 
ggplot(Tow_natives, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + facet_wrap(~fYear) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()
```

# Barplot
# Summarize - Mean + Standard Error
```{r}
Tow_summary2 <- Tow_natives %>% 
  group_by(Region, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

plot5 <- ggplot(Tow_summary2, aes(x = ActionPhase, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = Region)) + 
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + 
      annotate("text", x = "Post", y = 2e-05, label = "E", size = 8)  + 
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15))
```

#### Zero-inflated model

* Doesn't work - not enough samples?
```{r}

# For CPUE, use offset to account for sampling effort
Tow_natives$Samp <- log(Tow_natives$VolumeSampled)

# Formula
f2 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))

# Negbin
zinb2 <- zeroinfl(f2, na.action = "na.fail", dist="negbin", link = "logit", data = Tow_natives) ; summary(zinb2)

# Poisson
zip2 <- zeroinfl(f2, dist = "poisson", link = "logit", data = Tow_natives); summary(zip2)

# Hurdle
hrd2 <- hurdle(f2, dist="negbin", data = Tow_natives); summary(hrd2)
```

Compare zero-inflated poisson with zero-inflated negbin
```{r}
library(lmtest)
lrtest(zip2, zinb2)

BIC(zip2, zinb2, hrd2)
```

ZINB is the best. 
Compare zinb with nb, make sure zero inflation is the way to go
```{r}
# No zero inflation
nb2 <- glm.nb(f2,  data = Tow_natives) ; summary(nb2) 
vuong(nb2, zinb2)
```
NB better.  

#### Diagnostic Plots

Rootograms - should like like a typical overdispersed distribution
This compares observed and fitted frequencies
```{r}
par(mfrow = c(1,2))
rootogram(zinb2, main = "ZINB", ylim = c(-5, 15), max = 50)
qqrplot(zinb2)
```

Distribution of residuals by variable
```{r}

# Calculate residuals
EP2 <- resid(zinb2, type = "pearson")

# Diagnostic Plots
par(mfrow = c(2,2))
plot(x=Tow_natives$ActionPhase,y = EP2, main = "Action Phase")
plot(x=Tow_natives$Region, y = EP2, main = "Region")
plot(x=Tow_natives$fYear, y = EP2, main = "Year")
```

View Results
```{r}
par(mfrow = c(2,2))
visreg(zinb2)
```

Post-hoc
```{r}
m_means2 <- emmeans(zinb2, ~fYear)
multcomp::cld(m_means2, Letters = letters)
```



### Overall CPUE

#### Sum Overall CPUE
```{r}
Tow_f <- filter(Tow_f, !(CommonName %in% c("Crangon spp.", "Siberian Prawn", "NoCatch", "Mississippi Grass Shrimp")))
Tow_all <- Tow_f %>%
  group_by(Survey,fYear, Date, Region, StationCode, ActionPhase, MethodCode, VolumeSampled, Tow) %>%
  summarize(sumCPUE = sum(CPUE),
            sumCount = sum(sum.count))
```

#### Look at data


```{r}
# Proportion Species
TowSp <- ggplot(Tow_f, aes(x = fYear, y = CPUE, fill = CommonName)) + geom_col()+ theme_bw()  + theme(legend.position = "bottom") + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        axis.title.x = element_blank(),
        legend.text = element_text(size = 11),
        legend.title = element_blank())
ggplotly(TowSp)

library(plotly)

# Histogram
ggplot(Tow_all, aes(sumCPUE)) + geom_histogram(binwidth = .001) + theme_bw()

# Survey
ggplot(Tow_all, aes(x = Date, y = sumCPUE)) + geom_point() + facet_wrap(Survey~.) + theme_bw()

# Action Phase
ggplot(Tow_all, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Region
ggplot(Tow_all, aes(x = Region, y = sumCPUE)) + geom_jitter(aes(color = ActionPhase), size = 3) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

# Boxplot

Tow_all2 <- filter(Tow_all, sumCPUE<3)
ggplot(Tow_all2, aes(x = Region, y = sumCPUE)) + geom_boxplot(aes(fill = ActionPhase)) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()

ggplot(Tow_all2, aes(x = ActionPhase, y = sumCPUE)) + geom_boxplot(aes(fill = Region)) + scale_fill_viridis(discrete = TRUE, option = "viridis") + theme_bw()



# Year 
ggplot(Tow_all, aes(x = ActionPhase, y = sumCPUE)) + geom_jitter(aes(color = Region), size = 3) + facet_wrap(~fYear) + scale_color_viridis(discrete = TRUE, option = "viridis") + theme_bw()
```

# Barplot
# Summarize - Mean + Standard Error
```{r}
Tow_summary3 <- Tow_all %>% 
  group_by(Region, ActionPhase) %>%
  summarize(meanCPUE = mean(sumCPUE),
            n = n(),
            seCPUE = sqrt(var(sumCPUE)/sqrt(n))) 

plot6 <- ggplot(Tow_summary3, aes(x = ActionPhase, y = meanCPUE, ymin = meanCPUE - seCPUE, ymax = meanCPUE + seCPUE, fill = Region)) + 
  geom_bar(position = position_dodge(width = 0.9), stat = "identity") + 
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.4) + 
  scale_fill_viridis(discrete = TRUE, option = "viridis") + 
      annotate("text", x = "Post", y = .1, label = "F", size = 8)  + 
  theme_bw() + 
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15))

```

Merge plots
https://github.com/tidyverse/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs
```{r}

grid_arrange_shared_legend <- function(..., ncol = length(list(...)), nrow = 1, position = c("bottom", "right")) {

  plots <- list(...)
  position <- match.arg(position)
  g <- ggplotGrob(plots[[1]] + theme(legend.position = position))$grobs
  legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
  lheight <- sum(legend$height)
  lwidth <- sum(legend$width)
  gl <- lapply(plots, function(x) x + theme(legend.position="none"))
  gl <- c(gl, ncol = ncol, nrow = nrow)

  combined <- switch(position,
                     "bottom" = arrangeGrob(do.call(arrangeGrob, gl),
                                            legend,
                                            ncol = 1,
                                            heights = unit.c(unit(1, "npc") - lheight, lheight)),
                     "right" = arrangeGrob(do.call(arrangeGrob, gl),
                                           legend,
                                           ncol = 2,
                                           widths = unit.c(unit(1, "npc") - lwidth, lwidth)))

  grid.newpage()
  grid.draw(combined)

  # return gtable invisibly
  invisible(combined)
}


grid_arrange_shared_legend(plot4, plot5, plot6, ncol = 1, nrow = 3)

```


#### Model - normal glm
```{r}
m1all <- glm(sumCPUE~Region + fYear + ActionPhase, data = Tow_all); summary(m1all)

par(mfrow = c(2,2))
plot(m1all)

```

#### Model with log transformation
```{r}
Tow_all$logCPUE = log(Tow_all$sumCPUE + 1)
m2all <- glm(logCPUE~Region + fYear + ActionPhase, data = Tow_all); summary(m2all)

par(mfrow = c(2,2))
plot(m2all)

hist(Tow_all$logCPUE)
```

#### Model with poisson distribution
```{r}

# For CPUE, use offset to account for sampling effort
Tow_all$Samp <- log(Tow_all$VolumeSampled)

# Formula
f3 <- formula(sumCount ~ Region + fYear + ActionPhase + offset(Samp))

# Check overdispersion (var>mean)
var(Tow_all$sumCPUE)
mean(Tow_all$sumCPUE)

# Poisson distribution or quasipoisson (overdispersed)
m3all <- glm(f3, data = Tow_all, family = poisson); summary(m3all)
# See dispersion parameter

m3all$deviance/m3all$df.residual #overdispersed

```

#### Model with negative binomial distribution

* https://stats.idre.ucla.edu/r/dae/negative-binomial-regression/
```{r}
library(MASS)
m4all <- glm.nb(f3, data = Tow_all); summary(m4all)


# Confidence Intervals 
(est <- cbind(Estimate = coef(m5all), confint(m5all)))

# Incidence Rates (Count)
exp(est)
```

# Compare the two
```{r}
BIC(m3all, m4all)
```
Negative Binomial preferred.

Try interactions: m5all preferred
```{r}
m5all <- glm.nb(f4, data = Tow_all); summary(m5all)
m6all <- glm.nb(f5, data = Tow_all); summary(m6all)
m7all <- glm.nb(f6, data = Tow_all); summary(m7all)

BIC(m4all, m5all, m6all, m7all)
```

#### Diagnostic Plots
Rootogram
```{r}
par(mfrow = c(1,2))
rootogram(m5all)
qqrplot(m5all)
```

Plot residuals
```{r}
# Diagnostic Plots -------------------------------------
# Model Validation 
# Calculate residuals
EP3 <- resid(m5all, type = "pearson")

# Diagnostic Plots
par(mfrow = c(2,2))
plot(x=m5all$fitted.values, y = EP3, main = "Pearson residuals")
plot(x=Tow_all$ActionPhase,y = EP3, main = "Action Phase")
plot(x=Tow_all$Region, y = EP3, main = "Region")
plot(x=Tow_all$fYear, y = EP3, main = "Year")

```

View plot
```{r}
par(mfrow = c(2,2))
visreg(m5all)
```

Post-hoc

```{r}
m_means3 <- emmeans(m5all, ~fYear)
multcomp::cld(m_means3, Letters = letters)
```

**Conclusions**

* More samples in 2017-2019 (EDSM started?) 
* 2015-2016 > 2013-2017 > 2014 > 2018-2019
* Not sure about residual distribution
* More fish Upstream > Downstream > Middle Sac
* More fish Pre > Post > During 
* Run post-hoc tests on Year to compare years between each other - Tukey or GLHT
