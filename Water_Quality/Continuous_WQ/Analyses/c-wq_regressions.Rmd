```{r}
# C-WQ Regressions for Hypothesis Table
# Authors: Sarah Perry, Dave Bosworth
# Contacts: seperry83@gmail.com; David.Bosworth@water.ca.gov
```

```{r, message=FALSE}
# import packages
library(tidyverse)
library(lubridate)
library(lmerTest)
library(emmeans)
library(car)
library(magrittr)
source('global_ndfa_funcs.R')
source('Water_Quality/global_wq_funcs.R')

# import data
fp_wq <- ndfa_abs_sp_path('/WQ_Subteam/Processed_Data/Continuous/RTM_INPUT_all_2021-04-20.csv')
fp_region <- ndfa_abs_sp_path('/WQ_Subteam/Processed_Data/Continuous/NDFA_Cont_WQ_Stations.csv')

df_wq <- import_rtm_data(fp_wq, num_params = 10)
df_region <- read_csv(fp_region)

# remove excess cols in df_region
df_region %<>% select(StationCode, BroadRegion)

# Create vector of sites we aren't including (not available for all years)
remove <- c('SRH', 'SHR', 'SRV', 'WWT', 'DWT', 'SDI', 'SGG') # keep TOE, LIBCUT for now

# Clean and Prepare df_wq for analysis
df_wq_clean <- df_wq %>% 
  # Parse DateTime variable and create Date and Year variables
  mutate(
    DateTime = ymd_hms(DateTime),
    Date = date(DateTime),
    Year = year(DateTime)
  ) %>% 
  # Remove sites, parameters, and years we aren't including in the analysis
  filter(
    !StationCode %in% remove,
    Year > 2012
  ) %>% 
  select(
    !c(
      starts_with("Flow"), 
      starts_with("fDOM"), 
      starts_with("Nitrate"), 
      starts_with("WaterTemp")
    )
  ) %>% 
  # Pivot data longer
  select(!ends_with("_Qual")) %>% 
  pivot_longer(
    cols = -c(StationCode, DateTime, Date, Year),
    names_to = "Analyte",
    values_to = "Result"
  ) %>% 
  # Remove NA values
  filter(!is.na(Result)) %>% 
  # Calculate daily averages
  group_by(StationCode, Analyte, Year, Date) %>% 
  summarize(Result = mean(Result)) %>% 
  # Fill in missing days for each StationCode, Analyte, Year combination
  complete(Date = seq.Date(min(Date), max(Date), by = "1 day")) %>% 
  ungroup() %>% 
  # Log transform data
  mutate(Result = log(Result)) %>% 
  # Create lags
  arrange(StationCode, Analyte, Year, Date) %>% 
  group_by(StationCode, Analyte, Year) %>% 
  mutate(
    lag1 = lag(Result),
    lag2 = lag(Result, 2),
    lag3 = lag(Result, 3)
  ) %>% 
  ungroup() %>% 
  # Add Flow Action Periods, Regions, Month, and Week variables
  ndfa_action_periods() %>% 
  left_join(df_region) %>% 
  mutate(
    Month = as.character(month(Date)),
    Week = as.character(week(Date)),
    # Convert Year to character so it runs correctly in the model
    Year = as.character(Year)
  )
```

```{r all analytes}
analytes <- unique(df_wq_clean$Analyte)
all_reg_yr <- list()
all_reg_fa <- list()
all_reg_reg <- list()
all_aov <- list()

# Define file path for ANOVA Diagnostics Plots
fp_anova_diag <- ndfa_abs_sp_path("WQ_Subteam/Plots/Continuous/ANOVA_Diagnostics")

# Create function to add significance levels to pairwise tests
add_sign_levels_pw <- function(df) {
  df %>% 
    mutate(Significance = case_when(
      p.value >= 0 & p.value < 0.001 ~ '***',
      p.value >= 0.001 & p.value < 0.01 ~ '**',
      p.value >= 0.01 & p.value < 0.05 ~ '*',
      p.value >= 0.05 & p.value < 0.1 ~ '.',
      p.value >= 0.1 & p.value <= 1 ~ ' ',
      )
    )
}

for (i in seq(analytes)){
  df_temp <- df_wq_clean %>%
    filter(Analyte == analytes[i])
  
  # pacf(df_temp$Result, na.action = na.pass)

  lmer_fit <- lmer(Result ~ Year + Month + FlowActionPeriod + BroadRegion + lag1 + lag2 + (1|StationCode), data = df_temp)
  
  # create and save ANOVA Diagnostics plots
  pdf(paste0(fp_anova_diag, "/", analytes[i], "_daily_avg_ANOVA.pdf"))
  acf(residuals(lmer_fit), na.action = na.pass, main = analytes[i])
  plot(residuals(lmer_fit))
  qqnorm(residuals(lmer_fit))
  hist(residuals(lmer_fit), breaks = 15)
  dev.off()
  
  # Print results of Portmanteau test
  print(analytes[i])
  print(stats::Box.test(residuals(lmer_fit), lag = 10, type = 'Ljung-Box'))
  
  # Run Type II F-test
  aov_lmer <- Anova(lmer_fit, type = 'II', test.statistic = 'F')
  aov_lmer$Analyte <- analytes[i]
  aov_lmer$Variable <- rownames(aov_lmer)

  aov_lmer <- aov_lmer %>%
    mutate(Significance = case_when(
      `Pr(>F)` >= 0 & `Pr(>F)` < 0.001 ~ '***',
      `Pr(>F)` >= 0.001 & `Pr(>F)` < 0.01 ~ '**',
      `Pr(>F)` >= 0.01 & `Pr(>F)` < 0.05 ~ '*',
      `Pr(>F)` >= 0.05 & `Pr(>F)` < 0.1 ~ '.',
      `Pr(>F)` >= 0.1 & `Pr(>F)` <= 1 ~ ' ',
      )
    )

  lmer_rg <- ref_grid(lmer_fit)
  
  # Pairwise comparisons for Year
  lmer_emm_yr <- emmeans(
    lmer_rg, 
    specs = pairwise ~ Year:Year, 
    adjust = 'sidak'
  ) 
  cont_yr <- test(lmer_emm_yr)$contrasts
  cont_yr$Analyte <- analytes[i]
  df_cont_yr <- add_sign_levels_pw(cont_yr)
  
  # Pairwise comparisons for FlowActionPeriod
  lmer_emm_fa <- emmeans(
    lmer_rg, 
    specs = pairwise ~ FlowActionPeriod:FlowActionPeriod, 
    adjust = 'sidak'
  ) 
  cont_fa <- test(lmer_emm_fa)$contrasts
  cont_fa$Analyte <- analytes[i]
  df_cont_fa <- add_sign_levels_pw(cont_fa)
  
  # Pairwise comparisons for BroadRegion
  lmer_emm_reg <- emmeans(
    lmer_rg, 
    specs = pairwise ~ BroadRegion:BroadRegion, 
    adjust = 'sidak'
  ) 
  cont_reg <- test(lmer_emm_reg)$contrasts
  cont_reg$Analyte <- analytes[i]
  df_cont_reg <- add_sign_levels_pw(cont_reg)

  all_reg_yr[[i]] <- df_cont_yr
  all_reg_fa[[i]] <- df_cont_fa
  all_reg_reg[[i]] <- df_cont_reg
  all_aov[[i]] <- aov_lmer
}

# Combine results
all_reg_data_yr <- do.call(rbind, all_reg_yr)
all_reg_data_fa <- do.call(rbind, all_reg_fa)
all_reg_data_reg <- do.call(rbind, all_reg_reg)
all_aov_data <- do.call(rbind, all_aov)

# Export results as .csv files
fp_anova_results <- ndfa_abs_sp_path("WQ_Subteam/Analysis_Results/CWQ")

all_aov_data %>% 
  write_excel_csv(file.path(fp_anova_results, "cwq_aov_daily_avg_sea-month.csv"))

all_reg_data_yr %>% 
  write_excel_csv(file.path(fp_anova_results, "cwq_emmeans_year_daily_avg_sea-month.csv"))

all_reg_data_fa %>% 
  write_excel_csv(file.path(fp_anova_results, "cwq_emmeans_flowaction_daily_avg_sea-month.csv"))

all_reg_data_reg %>% 
  write_excel_csv(file.path(fp_anova_results, "cwq_emmeans_region_daily_avg_sea-month.csv"))
```

