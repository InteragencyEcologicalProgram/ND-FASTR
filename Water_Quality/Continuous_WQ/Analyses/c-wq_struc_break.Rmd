```{r}
# title: Structural Break Analysis
# authors: Sarah Perry and Traci Treleaven
```

Plan:
-- MUST DO --
Set Up Data
  - import data (DONE :D)
    - for loop to account for different stations, years, analytes (DONE :D)
    
  - detrend the data
    - gets rid of seasonal and other trends
    - will give us a linear trend (ideally)
    - need to check best way to do in R (should be simple though)
--------------


-- First Steps --
Look for differences Before/During/After
  - structural break analysis
    - don't manually define the boundaries
    
  - slope analysis
    - con: doesn't account for lag fully (manually define boundaries)
------------------

-- If Time --
Differences Between Regions
  - ARMA modeling
    - ARMA: auto-regressive moving averaging
    - similar to slope analysis (straight regression)
    - *might* be able to coefficients
    
  - granger correlation
    - shows if one timeseries can predict another
    - con: assumes that there's not a lot of differences
      - so might not work
      
  - correlation vs lag
    - fun idea, but def only do if there's extra time
    - might be able to track flow pulse through the regions
--------------


```{r}
# source functions
source('../Plots_Multi_Station/Code_cont_timeseries analysis_func.R')

# --- Import Data ---
# define main FASTR filepath (assumes sync'd with Sharepoint)
fp_fastr <- 'California Department of Water Resources/North Delta Flow Action - Documents/'

# define filepaths 
fp_rel_wq <- paste(fp_fastr,'WQ_Subteam/Processed_Data/Continuous/Combined_Files/combined_flow.csv', sep = '')
fp_abs_wq <- get_abs_path(fp_rel_wq)

# read in data
df_wq <- read_csv(
  fp_abs_wq,
  col_types = cols(
    .default = 'n',
    DateTime = 'T',
    Date = 'D',
    Year = 'c',
    PreFlowStart = 'c',
    PreFlowEnd = 'c',
    PostFlowStart = 'c',
    PostFlowEnd = 'c',
    ActionPhase = 'c',
    StationCode = 'c'
    )
)

# pivot longer
df_wq_long <- df_wq %>% 
  select(!ends_with('_Qual')) %>% 
  pivot_longer(
    cols = -c(DateTime, StationCode, Date, ActionPhase, PreFlowStart, PreFlowEnd, PostFlowStart, PostFlowEnd, Year),
    names_to = 'Analyte',
    values_to = 'Result')

# --- Clean Data ---
# add full analyte name column
df_wq_long <- add_analyte_names(df_wq_long)

# add unit column
df_wq_long <- add_analyte_units(df_wq_long)

# add region column
df_wq_long <- add_region(df_wq_long)
```

```{r}
# --- Prep for Graphs ---
# list of analytes/stations
analytes <- unique(df_wq_long$Analyte)
years <- unique(df_wq_long$Year)
stations <- unique(df_wq_long$StationCode)

# --- Create Timeseries --
# create plots
for (year in years){
  for (analyte in analytes){
    for (station in stations){
      # insert all the code we want to do here
      break
    }
    break
  }
  break
}

```


