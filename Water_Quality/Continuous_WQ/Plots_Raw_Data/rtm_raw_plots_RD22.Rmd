---
title: "Raw Data Plots - RD22"
author: "Dave Bosworth"
date: "8/28/2020"
output: 
  html_document: 
    code_folding: show
    toc: true
    toc_depth: 1
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

Create plots of the raw continuous water quality data for the RD22 station. The data in these plots has been cleaned and formatted, but not inspected for suspect values. The purpose of these plots is to allow for us to visually inspect the data for suspect or unreliable values during the study period (2011-2019). The final QA/QC steps for this data can be found in the xxx.Rmd file.

# Global code and functions

```{r load packages, message = FALSE, warning = FALSE}
library(tidyverse)
library(lubridate)
```

```{r load functions, message = FALSE, warning = FALSE}
# Source global WQ functions
source("Water_Quality/global_wq_funcs.R")

# Source continuous WQ raw data plot functions
source("Water_Quality/Continuous_WQ/Plots_Raw_Data/rtm_raw_plots_funcs.R")
```

```{r define file paths}
# Define main NDFA file path for WQ subteam (assumes synced with SharePoint)
fp_fastr <- "California Department of Water Resources/Office of Water Quality and Estuarine Ecology - North Delta Flow Action/WQ_Subteam/"

# Define relative file path for processed continuous WQ data file for RD22
fp_rel_rtm_data <- paste0(fp_fastr, "Processed_Data/Continuous/RTM_OUTPUT_RD22_formatted.csv")

# Define absolute file path
fp_abs_rtm_data <- get_abs_path(fp_rel_rtm_data)
```

```{r set system tz as PST}
# Set System Timezone as "Etc/GMT+8" (PST) to make it consistent with the data 
Sys.setenv(TZ = "Etc/GMT+8")
```

# Import and Prepare Data

```{r import data}
data_orig <- import_rtm_data(fp_abs_rtm_data, 7)
```

```{r prepare data, message = FALSE}
# Clean original data
data_clean <- data_orig %>% 
  # parse date-time variable and define tz as PST
  mutate(DateTime = ymd_hms(DateTime, tz = "Etc/GMT+8")) %>% 
  # pivot data longer for easier plotting
  select(-c(StationCode, ends_with("_Qual"))) %>% 
  pivot_longer(
    cols = -DateTime,
    names_to = "parameter",
    values_to = "value"
  ) %>% 
  # add a yr variable
  mutate(yr = year(DateTime))

# Find the first year with data for each parameter
data_first_yr <- data_clean %>% 
  filter(!is.na(value)) %>% 
  group_by(parameter) %>% 
  summarize(min_yr = min(yr))

# Create a nested dataframe grouped by parameter- including all years of data
data_all_yrs <- data_clean %>% 
  group_nest(parameter) %>%
  # remove data before the first year data was collected for each parameter
  left_join(data_first_yr) %>% 
  mutate(
    data = map2(data, min_yr, ~filter(.x, yr >= .y)),
    yr = "All Years"
  ) %>% 
  select(parameter, yr, data)

# Create a nested dataframe grouped by parameter and year
data_indiv_yrs <- data_clean %>% 
  filter(!is.na(value)) %>% 
  mutate(yr = as.character(yr)) %>% 
  group_nest(parameter, yr)

# Combine nested dataframes and add variable for y-axis label
data_yrs_c <- 
  bind_rows(data_all_yrs, data_indiv_yrs) %>% 
  add_yaxis_var(parameter)
```

# Create Plots

```{r create plots}
plots <- data_yrs_c %>% 
  mutate(plot = map2(data, yaxis_lab, .f = create_ts_plot)) %>% 
  select(parameter, yr, plot) %>% 
  group_nest(parameter)
```

# Raw Data Plots {.tabset .tabset-pills}

```{r print plots, echo = FALSE, warning = FALSE, results = "asis"}
for (i in 1:nrow(plots)) {
  # Create heading for each parameter
  cat("## ", as.character(plots$parameter[i]), " {.tabset .tabset-pills}\n\n")
  for (j in 1:nrow(plots$data[[i]])) {
    # Create subheadings for each yr
    cat("### ", as.character(plots$data[[i]]$yr[j]), "\n\n") 
    # Display plot
    print(plots$data[[i]]$plot[[j]])
    cat("\n\n")  
  }
}
```

