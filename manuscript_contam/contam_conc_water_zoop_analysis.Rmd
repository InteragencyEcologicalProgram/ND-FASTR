---
title: "NDFS Contaminants Manuscript"
subtitle: "Analyses of Total Concentrations in Water and Zooplankton"
author: "Dave Bosworth"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document: 
    code_folding: show
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = here::here("docs"),
      envir = globalenv()
    )
    })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

Run statistical analyses for Figure 4 in the NDFS contaminants manuscript to support the figure. Figure 4 shows the total pesticide concentrations in water and zooplankton samples collected from the Sacramento River (SHR) and Toe Drain (STTD) in the summer-fall periods in 2017, 2018 and 2019.

# Global code and functions

```{r load packages, message = FALSE, warning = FALSE}
# Load packages
library(tidyverse)
library(rlang)
library(patchwork)
library(car)
library(emmeans)
library(visreg)
library(here)
library(conflicted)

# Declare package conflict preferences 
conflicts_prefer(dplyr::filter())
```

```{r check working dir}
# Check if we are in the correct working directory
i_am("manuscript_contam/contam_conc_water_zoop_analysis.Rmd")
```

Display current versions of R and packages used for this analysis:

```{r print session info}
devtools::session_info()
```

Create function to plot model diagnostics:

```{r global funcs}
# Create model diagnostic plots to check assumptions
plot_model_diag <- function(df_data, param_var, unit_label, model, log_trans = FALSE, ...) {
  df_data <- df_data %>%
    mutate(
      Residuals = resid(model),
      Fitted = predict(model)
    )
  
  param_name <- as_name(ensym(param_var))
  
  if (log_trans == TRUE) {
    unit_label <- paste0("log[", unit_label, "]")
  }
  
  plt_hist <- ggplot(df_data, aes(x = Residuals)) +
    geom_histogram(...) +
    labs(
      title = "Residual Histogram", 
      x = "Residuals"
    ) +
    theme_bw()
  
  plt_qq <- ggplot(df_data, aes(sample = Residuals)) + 
    labs(
      title = "Residual Probability Plot", 
      x = "Normal Quantiles", 
      y = "Residuals"
    ) + 
    stat_qq() + 
    stat_qq_line(linewidth = 1, color = 'red') + 
    theme_bw()
  
  plt_res_fit <- ggplot(df_data, aes(x = Fitted, y = Residuals)) +
    geom_point() +
    labs(
      title = "Residuals vs. Fitted Values", 
      x = (paste0("Predicted ", param_name, " (", unit_label, ")")),
      y = paste0("Residuals (", unit_label, ")")
    ) +
    theme_bw()
  
  plt_obs_fit <- ggplot(df_data, aes(x = Fitted, y = {{ param_var}})) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0, color = "red") +
    labs(
      title = "Observed vs. Fitted Values", 
      x = paste0("Predicted ", param_name, " (", unit_label, ")"),
      y = paste0("Observed ", param_name, " (", unit_label, ")")
    ) +
    theme_bw()
  
  (plt_hist + plt_qq) / (plt_res_fit + plt_obs_fit)
}
```


# Import and Prepare Data

```{r import data}
# Total Pesticide Concentration data:
df_conc_all <- read_rds(here("manuscript_contam/data/contam_conc_water_zoop_2017-2019.rds"))

# Daily average flow data:
df_davg_flow <- read_rds(here("Water_Quality/Data_Processed/LIS_SR_DailyAvgFlow_2013-2022.rds"))
```

Join the concentration and flow data - SHR with SR at Freeport, and STTD with LIS. Use Daily Average Net flows for both.

```{r prepare data}
df_conc_flow_shr <- df_conc_all %>% 
  filter(Station == "SHR") %>% 
  left_join(
    df_davg_flow %>% select(Date, DailyAvgNetFlow = SR_DailyAvgNetFlow),
    by = join_by(Date)
  )

df_conc_flow_sttd <- df_conc_all %>% 
  filter(Station == "STTD") %>% 
  left_join(
    df_davg_flow %>% select(Date, DailyAvgNetFlow = LIS_DailyAvgNetFlow),
    by = join_by(Date)
  )

# Combine data
df_conc_flow_all <- bind_rows(df_conc_flow_shr, df_conc_flow_sttd)

# Look at all data
print(df_conc_flow_all, n = 70)
```

It looks like all of the flow data was available for SHR, but STTD is missing a few flow values in July 2019.

# Zooplankton Analysis

```{r prepare data zoop}
# Prepare zooplankton concentration data for analysis
df_zoop <- df_conc_flow_all %>% 
  select(-TotalConc_Water) %>% 
  drop_na() %>% 
  mutate(Year = as.character(year(Date)), .after = Date)
```

## Exploratory Plots

Before running the analyses, lets take a look at how the total pesticide concentrations in zooplankton vary with daily average net flow for each station.

```{r plot conc vs flow zoop}
df_zoop %>% 
  ggplot(aes(x = DailyAvgNetFlow, y = TotalConc_Zoop, color = Station)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x) +
  labs(
    x = "Daily average net flow (cfs)",
    y = "Total pesticide concentration in zooplankton (ng/g)"
  ) +
  theme_bw()

df_zoop %>% 
  ggplot(aes(x = DailyAvgNetFlow, y = TotalConc_Zoop, color = Year)) +
  geom_point() +
  scale_color_viridis_d(option = "plasma", end = 0.8) +
  facet_wrap(vars(Station), scales = "free") +
  labs(
    x = "Daily average net flow (cfs)",
    y = "Total pesticide concentration in zooplankton (ng/g)"
  ) +
  theme_bw()
```

SHR seems to have no or a weak negative relationship between concentration and flow, while concentrations at STTD seem to have a positive relationship with flow. The ranges of the daily average flows don't overlap between the two stations, so it may not make sense to run the Station-Flow model including both stations.

Next, lets look at a boxplot comparing total pesticide concentrations in zooplankton between stations.

```{r boxplot station zoop}
df_zoop %>% 
  ggplot(aes(x = Station, y = TotalConc_Zoop)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color = Year), width = 0.3) +
  scale_color_viridis_d(option = "plasma", end = 0.8) +
  ylab("Total pesticide concentration in zooplankton (ng/g)")
```

The median concentrations are pretty similar between stations, but STTD has some higher values than SHR particularly in 2018 and 2019. Let's break apart the boxplot by station and year.

```{r boxplot station year zoop}
df_zoop %>% 
  ggplot(aes(x = Year, y = TotalConc_Zoop, fill = Year)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2) +
  facet_wrap(vars(Station)) +
  scale_fill_viridis_d(option = "plasma", end = 0.8) +
  ylab("Total pesticide concentration in zooplankton (ng/g)")
```

Overall, STTD in 2019 had the highest concentrations. Let's look at a boxplot grouped only by year.

```{r boxplot yr zoop}
df_zoop %>% 
  ggplot(aes(x = Year, y = TotalConc_Zoop)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.3) +
  ylab("Total pesticide concentration in zooplankton (ng/g)")
```

Total concentrations were slightly higher in 2019 than other years when both stations are grouped together.

Lastly, let's take a look at the histogram of all total pesticide concentrations in zooplankton to look at its distribution.

```{r plot hist zoop, message = FALSE}
df_zoop %>% 
  ggplot(aes(x = TotalConc_Zoop)) +
  geom_histogram() +
  xlab("Total pesticide concentration in zooplankton (ng/g)")
```

We may need to transform the zooplankton concentration data for the analyses.

## Analyses

### Model with Station and Flow

We'll create a linear model of the zooplankton concentrations as a function of the interaction between station and daily average net flow. We'll start with the original concentration values, but we may need to transform them. This model will allow us to examine:

1) Do total pesticide concentrations in zooplankton significantly respond to flow at either or both SHR and STTD?
2) Whether total pesticide concentrations in zooplankton are significantly higher at one of the stations controlling for the effect of flow. This can only be assessed if the interaction between station and daily average net flow isn't significant.

```{r lm sta flow zoop}
m_zoop_sta_flow <- df_zoop %>% lm(TotalConc_Zoop ~ Station * DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm sta flow zoop diag, message = FALSE}
df_zoop %>% plot_model_diag(TotalConc_Zoop, "ng/g", m_zoop_sta_flow)
shapiro.test(m_zoop_sta_flow$residuals)
```

The residuals deviate from a normal distribution according to the Shapiro-Wilk normality test and visual inspection. We'll re-run the model using the natural log of the concentration values summed by 1 to account for the two concentrations equal to zero.

```{r lm sta flow zoop log}
df_zoop_log <- df_zoop %>% mutate(TotalConc_Zoop = log(TotalConc_Zoop + 1))

m_zoop_sta_flow_log <- df_zoop_log %>% lm(TotalConc_Zoop ~ Station * DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm sta flow zoop log diag, message = FALSE}
df_zoop_log %>% plot_model_diag(TotalConc_Zoop, "ng/g", m_zoop_sta_flow_log, log_trans = TRUE)
shapiro.test(m_zoop_sta_flow_log$residuals)
```

This is actually worse than the model with original values. Let's try a square root transformation.

```{r lm sta flow zoop sqrt}
df_zoop_sqrt <- df_zoop %>% mutate(TotalConc_Zoop = sqrt(TotalConc_Zoop))

m_zoop_sta_flow_sqrt <- df_zoop_sqrt %>% lm(TotalConc_Zoop ~ Station * DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm sta flow zoop sqrt diag, message = FALSE}
df_zoop_sqrt %>% plot_model_diag(TotalConc_Zoop, "ng/g", m_zoop_sta_flow_sqrt)
shapiro.test(m_zoop_sta_flow_sqrt$residuals)
```

The square root transformed data looks to be slightly better than the original values. Let's take a look at the Anova table using type 3 sum of squares for the model using square root transformation.

```{r anova sta flow zoop}
Anova(m_zoop_sta_flow_sqrt, type = 3, contrasts = list(topic = contr.sum, sys = contr.sum))
```

The significant interaction between station and daily average net flow indicates that the regression slopes are different between the two stations. This isn't surprising looking at the concentration vs flow plots above. The Anova table also shows that the main effect of station was significant while the main effect of flow wasn't. These probably shouldn't be interpreted as such since the interaction term is strongly significant. To look at how flow affects total pesticide concentrations in zooplankton, we'll need to run separate models for each station.

#### SHR

We'll start with SHR

```{r lm flow zoop shr}
df_zoop_shr <- df_zoop %>% filter(Station == "SHR")

m_zoop_flow_shr <- df_zoop_shr %>% lm(TotalConc_Zoop ~ DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm flow zoop shr diag, message = FALSE}
df_zoop_shr %>% plot_model_diag(TotalConc_Zoop, "ng/g", m_zoop_flow_shr)
shapiro.test(m_zoop_flow_shr$residuals)
```

There are a couple of outliers with much lower predicted values, but the residuals appear to be fairly normally-distributed, so we'll take a closer look at this model.

```{r lm flow zoop shr summ, warning = FALSE}
summary(m_zoop_flow_shr)
visreg(m_zoop_flow_shr, gg = TRUE) + theme_bw() + geom_point(size = 1)
```

The relationship between concentration and flow is significant at SHR, with a negative slope; however, there are two values with flows larger than 40,000 cfs that have a lot of leverage on the model. Let's see what happens if we remove these two values.

```{r lm flow zoop shr 2}
df_zoop_shr2 <- df_zoop_shr %>% filter(DailyAvgNetFlow < 40000)

m_zoop_flow_shr2 <- df_zoop_shr2 %>% lm(TotalConc_Zoop ~ DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm flow zoop shr 2 diag, message = FALSE}
df_zoop_shr2 %>% plot_model_diag(TotalConc_Zoop, "ng/g", m_zoop_flow_shr2)
shapiro.test(m_zoop_flow_shr2$residuals)
```

The diagnostics look really good. Let's see how concentration varies with flow at SHR with the two values with higher flows removed.

```{r lm flow zoop shr 2 summ, warning = FALSE}
summary(m_zoop_flow_shr2)
visreg(m_zoop_flow_shr2, gg = TRUE) + theme_bw() + geom_point(size = 1)
```

The relationship between concentration and flow is no longer significant at SHR without the two values with high leverage.

#### STTD

Next, we'll look at STTD

```{r lm flow zoop sttd}
df_zoop_sttd <- df_zoop %>% filter(Station == "STTD")

m_zoop_flow_sttd <- df_zoop_sttd %>% lm(TotalConc_Zoop ~ DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm flow zoop sttd diag, message = FALSE}
df_zoop_sttd %>% plot_model_diag(TotalConc_Zoop, "ng/g", m_zoop_flow_sttd)
shapiro.test(m_zoop_flow_sttd$residuals)
```

The residuals deviate from a normal distribution according to the Shapiro-Wilk normality test and visual inspection. We'll re-run the model using the square root transformation since that worked well for all data combined.

```{r lm flow zoop sqrt sttd}
df_zoop_sttd_sqrt <- df_zoop_sttd %>% mutate(TotalConc_Zoop = sqrt(TotalConc_Zoop))

m_zoop_flow_sttd_sqrt <- df_zoop_sttd_sqrt %>% lm(TotalConc_Zoop ~ DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm flow zoop sqrt sttd diag, message = FALSE}
df_zoop_sttd_sqrt %>% plot_model_diag(TotalConc_Zoop, "ng/g", m_zoop_flow_sttd_sqrt)
shapiro.test(m_zoop_flow_sttd_sqrt$residuals)
```

The square root transformation worked really well for this data. Let's take a closer look at this model.

```{r lm flow zoop sqrt sttd summ, warning = FALSE}
summary(m_zoop_flow_sttd_sqrt)
visreg(m_zoop_flow_sttd_sqrt, gg = TRUE) + theme_bw() + geom_point(size = 1)
```

Total pesticide concentrations increase significantly with flow at the STTD station.

### Model with Station and Year

Next, we'll create a linear model of the zooplankton concentrations as a function of the interaction between station and year. We'll start with the original concentration values, but we may need to transform them. This model will allow us to examine:

1) If the interaction between station and year isn't significant, whether total pesticide concentrations in zooplankton are significantly different among stations or years (main effects).
2) If the interaction is significant, whether total pesticide concentrations in zooplankton are significantly different among stations for each year or among years for each station.

```{r lm sta yr zoop}
m_zoop_sta_yr <- df_zoop %>% lm(TotalConc_Zoop ~ Station * Year, data = .)
```

Plot the diagnostics

```{r lm sta yr zoop diag, message = FALSE}
df_zoop %>% plot_model_diag(TotalConc_Zoop, "ng/g", m_zoop_sta_yr)
shapiro.test(m_zoop_sta_yr$residuals)
```

The residuals deviate from a normal distribution according to the Shapiro-Wilk normality test and visual inspection. Also, the variance among groups isn't consistent. We'll re-run the model using the natural log of the concentration values summed by 1 to account for the two concentrations equal to zero.

```{r lm sta yr zoop log}
m_zoop_sta_yr_log <- df_zoop_log %>% lm(TotalConc_Zoop ~ Station * Year, data = .)
```

Plot the diagnostics

```{r lm sta yr zoop log diag, message = FALSE}
df_zoop_log %>% plot_model_diag(TotalConc_Zoop, "ng/g", m_zoop_sta_yr_log, log_trans = TRUE)
shapiro.test(m_zoop_sta_yr_log$residuals)
```

This is actually worse than the model with original values because of the two concentrations equal to zero. Let's try a square root transformation.

```{r lm sta yr zoop sqrt}
m_zoop_sta_yr_sqrt <- df_zoop_sqrt %>% lm(TotalConc_Zoop ~ Station * Year, data = .)
```

Plot the diagnostics

```{r lm sta yr zoop sqrt diag, message = FALSE}
df_zoop_sqrt %>% plot_model_diag(TotalConc_Zoop, "ng/g", m_zoop_sta_yr_sqrt)
shapiro.test(m_zoop_sta_yr_sqrt$residuals)
```

The square root transformed data looks to be better than the original values for both model assumptions of normally-distributed residuals and homogeneity of variance. Let's take a look at the Anova table using type 3 sum of squares for the model using square root transformation.

```{r anova sta yr zoop}
Anova(m_zoop_sta_yr_sqrt, type = 3, contrasts = list(topic = contr.sum, sys = contr.sum))
```

Well, the interaction term is not significant which means we can take a look at the main effects. Before we do this, we'll remove the interaction from the model since it's not necessary. We'll stick with the model using square root transformation.

```{r lm sta yr zoop sqrt no int, message = FALSE}
m_zoop_sta_yr_sqrt2 <- df_zoop_sqrt %>% lm(TotalConc_Zoop ~ Station + Year, data = .)
df_zoop_sqrt %>% plot_model_diag(TotalConc_Zoop, "ng/g", m_zoop_sta_yr_sqrt2)
shapiro.test(m_zoop_sta_yr_sqrt2$residuals)
```

The diagnostics still look good with this model. Let's take a look at the Anova table using type 2 sum of squares.

```{r anova sta yr zoop no int, warning = FALSE}
Anova(m_zoop_sta_yr_sqrt2, type = 2)
```

The main effect of station is not significant meaning that total pesticide concentrations in zooplankton don't differ between SHR and STTD. However, the main effect of Year is marginally significant, so we can take a look at the pairwise contrasts to see how concentrations differ among the years.

```{r contrast sta yr zoop no int, warning = FALSE}
emmeans(m_zoop_sta_yr_sqrt2, specs = pairwise ~ Year)
visreg(m_zoop_sta_yr_sqrt2, xvar = "Year")
```

Pairwise tests indicate that total pesticide concentration in zooplankton in 2019 is marginally significantly higher than 2017.


# Water Analysis

```{r prepare data water}
# Prepare water concentration data for analysis
df_water <- df_conc_flow_all %>% 
  select(-TotalConc_Zoop) %>% 
  # only include 2019 since that was the only year water samples were collected
    # at STTD
  filter(year(Date) == 2019) %>% 
  drop_na()
```

## Exploratory Plots

Before running the analyses, lets take a look at how the total pesticide concentrations in water vary with daily average net flow for each station.

```{r plot conc vs flow water}
df_water %>% 
  ggplot(aes(x = DailyAvgNetFlow, y = TotalConc_Water, color = Station)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x) +
  labs(
    x = "Daily average net flow (cfs)",
    y = "Total pesticide concentration in water (ng/L)"
  ) +
  theme_bw()

df_water %>% 
  ggplot(aes(x = DailyAvgNetFlow, y = TotalConc_Water)) +
  geom_point() +
  facet_wrap(vars(Station), scales = "free") +
  labs(
    x = "Daily average net flow (cfs)",
    y = "Total pesticide concentration in water (ng/L)"
  ) +
  theme_bw()
```

Both SHR and STTD seem to have positive relationships between concentration and flow, but they look weak and strongly affected by values with the highest flows at each station. Both of these values with the highest flows have much lower than "expected" concentrations. Also as with the zooplankton data, the ranges of the daily average flows don't overlap between the two stations, so it may not make sense to run the Station-Flow model including both stations.

Next, lets look at a boxplot comparing total pesticide concentrations in water between stations.

```{r boxplot station water}
df_water %>% 
  ggplot(aes(x = Station, y = TotalConc_Water)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.3) +
  ylab("Total pesticide concentration in water (ng/L)")
```

STTD seems to have higher concentrations with much more variation than SHR.

Lastly, let's take a look at the histogram of all total pesticide concentrations in water to look at its distribution.

```{r plot hist water, message = FALSE}
df_water %>% 
  ggplot(aes(x = TotalConc_Water)) +
  geom_histogram() +
  xlab("Total pesticide concentration in water (ng/L)")
```

We may need to transform the water concentration data for the analyses.

## Analyses

### Model with Station and Flow

We'll create a linear model of the water concentrations as a function of the interaction between station and daily average net flow. We'll start with the original concentration values, but we may need to transform them. This model will allow us to examine:

1) Do total pesticide concentrations in water significantly respond to flow at either or both SHR and STTD?
2) Whether total pesticide concentrations in water are significantly higher at one of the stations controlling for the effect of flow. This can only be assessed if the interaction between station and daily average net flow isn't significant.

```{r lm sta flow water}
m_water_sta_flow <- df_water %>% lm(TotalConc_Water ~ Station * DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm sta flow water diag, message = FALSE}
df_water %>% plot_model_diag(TotalConc_Water, "ng/L", m_water_sta_flow)
shapiro.test(m_water_sta_flow$residuals)
```

The residuals deviate from a normal distribution according to the Shapiro-Wilk normality test and visual inspection. Also, the variance of the residuals isn't homogeneous. We'll re-run the model using the natural log of the concentration values.

```{r lm sta flow water log}
df_water_log <- df_water %>% mutate(TotalConc_Water = log(TotalConc_Water))

m_water_sta_flow_log <- df_water_log %>% lm(TotalConc_Water ~ Station * DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm sta flow water log diag, message = FALSE}
df_water_log %>% plot_model_diag(TotalConc_Water, "ng/L", m_water_sta_flow_log, log_trans = TRUE)
shapiro.test(m_water_sta_flow_log$residuals)
```

The diagnostics look much better with the log-transformed values. Let's take a look at the Anova table using type 3 sum of squares for the model using natural log transformation.

```{r anova sta flow water}
Anova(m_water_sta_flow_log, type = 3, contrasts = list(topic = contr.sum, sys = contr.sum))
```

The interaction between station and daily average net flow is marginally significant indicating that the regression slopes are somewhat different between the two stations. This is corroborated by the concentration vs flow plots above. To look at how flow affects total pesticide concentrations in water, it would be best to run separate models for each station.

#### SHR

We'll start with SHR

```{r lm flow water shr}
df_water_shr <- df_water %>% filter(Station == "SHR")

m_water_flow_shr <- df_water_shr %>% lm(TotalConc_Water ~ DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm flow water shr diag}
df_water_shr %>% plot_model_diag(TotalConc_Water, "ng/L", m_water_flow_shr, bins = 8)
shapiro.test(m_water_flow_shr$residuals)
```

The diagnostics look pretty good with this model, so we'll take a closer look at it.

```{r lm flow water shr summ, warning = FALSE}
summary(m_water_flow_shr)
visreg(m_water_flow_shr, gg = TRUE) + theme_bw() + geom_point(size = 1)
```

The relationship between concentration and flow isn't significant at SHR, but, there are two values with flows larger than 40,000 cfs that have some leverage on the model. Let's see what happens if we remove these two values.

```{r lm flow water shr 2}
df_water_shr2 <- df_water_shr %>% filter(DailyAvgNetFlow < 40000)

m_water_flow_shr2 <- df_water_shr2 %>% lm(TotalConc_Water ~ DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm flow water shr 2 diag}
df_water_shr2 %>% plot_model_diag(TotalConc_Water, "ng/L", m_water_flow_shr2, bins = 8)
shapiro.test(m_water_flow_shr2$residuals)
```

The diagnostics look really good. Let's see how concentration varies with flow at SHR with the two values with higher flows removed.

```{r lm flow water shr 2 summ, warning = FALSE}
summary(m_water_flow_shr2)
visreg(m_water_flow_shr2, gg = TRUE) + theme_bw() + geom_point(size = 1)
```

The positive relationship between concentration and flow is significant at SHR without the two values with the highest flows. These two values were collected at the end of May and beginning of June in 2019. 2019 was a wet year in N CA, so these two samples were most likely collected when flows were receding in the Sacramento River after the wet winter.

#### STTD

Next, we'll look at STTD

```{r lm flow water sttd}
df_water_sttd <- df_water %>% filter(Station == "STTD")

m_water_flow_sttd <- df_water_sttd %>% lm(TotalConc_Water ~ DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm flow water sttd diag}
df_water_sttd %>% plot_model_diag(TotalConc_Water, "ng/L", m_water_flow_sttd, bins = 8)
shapiro.test(m_water_flow_sttd$residuals)
```

The diagnostics look pretty good with this model, but it may be better with the log transformed values. Let's take a look at that.

```{r lm flow water log sttd}
df_water_sttd_log <- df_water_sttd %>% mutate(TotalConc_Water = log(TotalConc_Water))

m_water_flow_sttd_log <- df_water_sttd_log %>% lm(TotalConc_Water ~ DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm flow water log sttd diag}
df_water_sttd_log %>% plot_model_diag(TotalConc_Water, "ng/L", m_water_flow_sttd_log, log_trans = TRUE, bins = 5)
shapiro.test(m_water_flow_sttd_log$residuals)
```

The diagnostics look better for STTD with the log transformed values, so let's take a closer look at this one.

```{r lm flow water log sttd summ, warning = FALSE}
summary(m_water_flow_sttd_log)
visreg(m_water_flow_sttd_log, gg = TRUE) + theme_bw() + geom_point(size = 1)
```

Total pesticide concentrations increase significantly with flow at the STTD station, but only marginally. Again, there is one value with a flow larger than 1,000 cfs that has some leverage on the model. Let's see what happens if we remove it.

```{r lm flow water log sttd 2}
df_water_sttd_log2 <- df_water_sttd_log %>% filter(DailyAvgNetFlow < 1000)

m_water_flow_sttd_log2 <- df_water_sttd_log2 %>% lm(TotalConc_Water ~ DailyAvgNetFlow, data = .)
```

Plot the diagnostics

```{r lm flow water log sttd 2 diag}
df_water_sttd_log2 %>% plot_model_diag(TotalConc_Water, "ng/L", m_water_flow_sttd_log2, bins = 5)
shapiro.test(m_water_flow_sttd_log2$residuals)
```

The diagnostics look good. Let's see how concentration varies with flow at STTD with the one value with higher flow removed.

```{r lm flow water log sttd 2 summ, warning = FALSE}
summary(m_water_flow_sttd_log2)
visreg(m_water_flow_sttd_log2, gg = TRUE) + theme_bw() + geom_point(size = 1)
```

Now the positive relationship between total pesticide concentrations in water and flow at the STTD station is much more significant without the one value with the highest flow. Again, this sample was collected at the end of May in 2019, most likely when flows were receding in the Yolo Bypass after the wet winter.

### Station comparison

Next, let's compare total pesticide concentrations in water between the two stations, SHR and STTD. Since samples were only collected at both stations in 2019, we can run a simple t-test to compare them. The histogram of all water concentrations above showed that they are not normally-distributed. Let's take a look at the natural log transformed values to see if we can use these for the t-test.

```{r sta water diag}
df_water_log %>% 
  ggplot(aes(x = TotalConc_Water)) +
  geom_histogram(bins = 10) +
  xlab("Total pesticide concentration in water log(ng/L)")

df_water_log %>% 
  ggplot(aes(x = Station, y = TotalConc_Water)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.3) +
  ylab("Total pesticide concentration in water log(ng/L)")

df_water_log %>% 
  ggplot(aes(sample = TotalConc_Water)) + 
  labs(
    x = "Normal Quantiles", 
    y = "Total pesticide concentration in water log(ng/L)"
  ) + 
  stat_qq() + 
  stat_qq_line(linewidth = 1, color = 'red') + 
  theme_bw()

shapiro.test(df_water_log$TotalConc_Water)
```

The natural log transformed values seem to be more normally distributed and have relatively equal variances between SHR and STTD. Let's run Welch's two-sample t-test to compare the means of total pesticide concentration in water between SHR and STTD.

```{r sta water ttest}
df_water_log %>% t.test(TotalConc_Water ~ Station, data = .)
```

The mean total pesticide concentration in water was significantly higher at STTD than SHR during 2019.

# Overall Conclusions

Models including station and daily average net flow for both response variables, water and zooplankton concentration, had the unusual situation where the ranges of the flows didn't overlap between the two stations; therefore, it may not make sense to interpret these Station-Flow models. Other conclusions are grouped by the response variable.

Total pesticide concentrations in Zooplankton:

* There was a significant interaction (p < 0.0001) between station and daily average net flow indicating that the regression slopes are different between the two stations. This implies that concentrations at the two stations respond differently to flow.
* The negative relationship between concentration and flow was significant at SHR; however, there are two values with flows larger than 40,000 cfs that had a lot of leverage on the model. When these two values were removed from the analysis, the relationship between concentration and flow was no longer significant. These two values were collected at the end of May and beginning of June in 2019, most likely when flows were receding in the Sacramento River after the wet winter.
* In contrast, total pesticide concentrations increased significantly with flow at the STTD station (p < 0.0001).
* Total pesticide concentrations didn't differ significantly between SHR and STTD when controlling for the year when the samples were collected.
* Zooplankton concentrations were marginally significantly higher (p = 0.07) in 2019 than 2017 across both stations.

Total pesticide concentrations in Water:

* There was a marginally significant (p = 0.05) interaction between station and daily average net flow indicating that concentrations at the two stations respond somewhat differently to flow. 
* The relationship between concentration and flow wasn't significant at SHR, but there are two values with flows larger than 40,000 cfs that had some leverage on the model. When these two values were removed from the analysis, the relationship between concentration and flow was significantly positive (p < 0.001) at SHR. As with the zooplankton analysis, these two values were collected at the end of May and beginning of June in 2019, most likely when flows were receding in the Sacramento River after the wet winter.
* Total pesticide concentrations increased significantly with flow at the STTD station, but only marginally (p = 0.9); however, there is one value with a flow larger than 1,000 cfs that had some leverage on the model. When this value was removed from the analysis, the positive relationship between concentration and flow at the STTD station was much more significant (p < 0.001). Again, this sample was collected at the end of May in 2019, most likely when flows were receding in the Yolo Bypass after the wet winter.
* The mean total pesticide concentration in water was significantly higher (p = 0.011) at STTD than SHR during 2019.

